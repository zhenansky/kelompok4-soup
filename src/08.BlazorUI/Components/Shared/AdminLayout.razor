@using MyApp.BlazorUI.Services
@inherits LayoutComponentBase
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Components.Authorization
@using MyApp.BlazorUI.Services.Interfaces
@using MyApp.BlazorUI.DTOs.Auth
@using Blazored.LocalStorage;
@using System.Security.Claims
@inject AuthenticationStateProvider AuthStateProvider
@inject Blazored.LocalStorage.ILocalStorageService _localStorage
@inject IAuthService AuthService
@inject ISnackbar Snackbar

<MudThemeProvider Theme="CustomTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
  <MudAppBar Style="height:4rem; background-color: #FABC1D;">
    <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge=" Edge.Start"
      OnClick="@((e) => DrawerToggle())" />
    <MudText Typo="Typo.h6">
      @title
    </MudText>
  </MudAppBar>

  <MudDrawer @bind-Open="@_drawerOpen">
    <MudDrawerHeader Class="d-flex align-center">
      <MudText Class="d-flex justify-center" Style="width: 100%;" Typo="Typo.body1">Main Menu</MudText>
    </MudDrawerHeader>

    <MudNavMenu Class="d-flex flex-column" Style="width: 100%;">
      <MudLink Href="/admin-dashboard" Class="nav-link">
        <MudButton Class="nav-btn">
          <MudIcon Icon="@Icons.Material.Filled.Dashboard" />
          <MudText Class="nav-text">Dashboard</MudText>
        </MudButton>
      </MudLink>

      <MudLink Href="/admin-user" Class="nav-link">
        <MudButton Class="nav-btn">
          <MudIcon Icon="@Icons.Material.Filled.PermContactCalendar" />
          <MudText Class="nav-text">User Management</MudText>
        </MudButton>
      </MudLink>

      <MudLink Href="/admin-payment" Class="nav-link">
        <MudButton Class="nav-btn">
          <MudIcon Icon="@Icons.Material.Filled.Payments" />
          <MudText Class="nav-text">Payment Method</MudText>
        </MudButton>
      </MudLink>

      <MudDivider Class="my-1 line" />

      <MudDrawerHeader Class="d-flex align-center">
        <MudText Class="d-flex justify-center" Style="width: 100%;" Typo="Typo.body1">Action Menu</MudText>
      </MudDrawerHeader>

      <!-- PENTING: gunakan OnClick pada button, bukan Href pada link -->
      <MudButton Class="nav-btn" OnClick="Logout">
        <MudIcon Icon="@Icons.Material.Filled.ExitToApp" />
        <MudText Class="nav-text">Logout</MudText>
      </MudButton>
    </MudNavMenu>
  </MudDrawer>

  <MudMainContent Class="main">
    @Body
  </MudMainContent>
</MudLayout>

@code {
  bool _drawerOpen = true;
  string title = "Dashboard";

  void DrawerToggle()
  {
    _drawerOpen = !_drawerOpen;
  }

  MudTheme CustomTheme = new MudTheme()
  {
    Typography = new Typography()
    {
      Default = new DefaultTypography()
      {
        FontFamily = new[] { "Montserrat", "Helvetica", "Arial", "sans-serif" }
      }
    }
  };

  private async Task Logout()
  {
    try
    {
      var result = await AuthService.LogoutAsync();
      if (result != null && result.Success)
      {
        Snackbar.Add("Berhasil logout!", Severity.Success);

        // Hapus token local
        await _localStorage.RemoveItemAsync("authToken");

        // Refresh auth state via CustomAuthStateProvider jika tersedia
        if (AuthStateProvider is CustomAuthStateProvider customProvider)
        {
          // Hapus token local
          await _localStorage.RemoveItemAsync("accessToken");

          // Update auth state
          customProvider.NotifyUserLogout();
        }

        // Arahkan ke halaman login
        Navigation.NavigateTo("/login", forceLoad: true);
      }
      else
      {
        Snackbar.Add(result?.Message ?? "Gagal logout!", Severity.Error);
      }
    }
    catch (Exception ex)
    {
      Snackbar.Add($"Error: {ex.Message}", Severity.Error);
    }
  }
}