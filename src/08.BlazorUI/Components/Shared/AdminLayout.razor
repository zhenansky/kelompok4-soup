@using MyApp.BlazorUI.Services
@inherits LayoutComponentBase
@using MyApp.BlazorUI.Services.Interfaces
@using System.IdentityModel.Tokens.Jwt;
@using Blazored.LocalStorage;
@using Microsoft.AspNetCore.Components.Authorization
@using MyApp.BlazorUI.DTOs.Auth
@using System.Security.Claims
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject TokenService TokenService
@inject Blazored.LocalStorage.ILocalStorageService _localStorage
@inject IAuthService AuthService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

@inject ILocalStorageService LocalStorage


<MudThemeProvider Theme="CustomTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>

  <!-- APP BAR -->
  <MudAppBar Elevation="4" Style="height:4rem; background-color:#FABC1D; color:white;">
    <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start"
      OnClick="@((e) => DrawerToggle())" />
    <MudText Typo="Typo.h6" Class="ml-2 font-semibold">@title</MudText>
  </MudAppBar>

  <!-- DRAWER / SIDEBAR -->
  <MudDrawer @bind-Open="@_drawerOpen" Variant="DrawerVariant.Responsive" Elevation="2"
    Style="background-color:#fff; min-width:230px;">

    <MudDrawerHeader Class="py-3">
      <MudText Typo="Typo.subtitle1" Align="Align.Center" Style="font-weight:600; color:#222;">
        Main Menu
      </MudText>
    </MudDrawerHeader>

    <MudNavMenu Class="px-2">
      @foreach (var item in NavItems)
      {
        <MudLink Href="@item.Href" Class="nav-link">
          <MudButton FullWidth="true" Variant="Variant.Text" Color="Color.Inherit"
            Class="@($"nav-btn {(CurrentUrl == item.Href ? "active" : "")}")"
            Style="color:#222; text-transform:none; justify-content:flex-start;">
            <MudIcon Icon="@item.Icon" Style="color:#222; margin-right:8px;" />
            <MudText Class="nav-text" Style="color:#222; white-space:normal; line-height:1.2;">
              @item.Label
            </MudText>
          </MudButton>
        </MudLink>
      }

      <MudDivider Class="my-2" />

      <MudDrawerHeader Class="py-3">
        <MudText Typo="Typo.subtitle1" Align="Align.Center" Style="font-weight:600; color:#222;">
          Action Menu
        </MudText>
      </MudDrawerHeader>

      <MudButton FullWidth="true" Variant="Variant.Text" Color="Color.Inherit" OnClick="GoHome" Class="nav-btn"
        Style="color:#222; text-transform:none; justify-content:flex-start;">
        <MudIcon Icon="@Icons.Material.Filled.Home" Style="color:#222; margin-right:8px;" />
        <MudText Class="nav-text" Style="color:#222;">Homepage</MudText>
      </MudButton>

      <MudButton FullWidth="true" Variant="Variant.Text" Color="Color.Inherit" OnClick="Logout" Class="nav-btn"
        Style="color:#222; text-transform:none; justify-content:flex-start;">
        <MudIcon Icon="@Icons.Material.Filled.ExitToApp" Style="color:#222; margin-right:8px;" />
        <MudText Class="nav-text" Style="color:#222;">Logout</MudText>
      </MudButton>
    </MudNavMenu>
  </MudDrawer>


  <!-- MAIN CONTENT -->
  <MudMainContent Class="main-content p-4" Style="background-color:#F9FAFB;">
    @Body
  </MudMainContent>

</MudLayout>

<style>
  .nav-btn {
    justify-content: flex-start;
    color: #444;
    border-radius: 8px;
    padding: 8px 12px;
    text-transform: none;
    transition: all 0.2s ease-in-out;
  }

  .nav-btn:hover {
    background-color: #f1f1f1;
    color: #000;
  }

  .nav-text {
    font-weight: 500;
    font-size: 0.95rem;
  }

  .main-content {
    margin-top: 4rem;
    min-height: calc(100vh - 4rem);
    background-color: #F9FAFB;
    padding: 1.5rem;
  }

  @@media (max-width: 768px) {
    .nav-btn {
      font-size: 0.9rem;
      padding: 6px 10px;
    }
  }
</style>

@code {
  bool _drawerOpen = true;
  string title = "Dashboard";

  private string? CurrentUrl;

  void DrawerToggle() => _drawerOpen = !_drawerOpen;

  MudTheme CustomTheme = new MudTheme()
  {
    Typography = new Typography()
    {
      Default = new DefaultTypography()
      {
        FontFamily = new[] { "Montserrat", "Helvetica", "Arial", "sans-serif" }
      }
    }
  };

  private void GoHome()
  {
    NavigationManager.NavigateTo("/", forceLoad: true);
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender)
      return;

    var token = await _localStorage.GetItemAsync<string>("accessToken");

    var authState = await TokenService.GetCustomAuthenticationStateAsync(token);
    var user = authState.User;

    var _isLoggedIn = user.Identity?.IsAuthenticated ?? false;
    var _userRole = user.FindFirst("role")?.Value ?? "User";

    // ðŸš¨ Check if not admin
    if (!_isLoggedIn || !_userRole.Equals("Admin", StringComparison.OrdinalIgnoreCase))
    {
      // Redirect to home if not admin
      Navigation.NavigateTo("/", forceLoad: true);
      return; // â›” stop further execution
    }

    // ðŸ”„ Listen for authentication state changes
    if (AuthStateProvider is CustomAuthStateProvider customProvider)
    {
      customProvider.AuthenticationStateChanged += async task =>
      {
        var state = await task;
        var changedUser = state.User;
        _isLoggedIn = changedUser.Identity?.IsAuthenticated ?? false;
        _userRole = changedUser.FindFirst("role")?.Value ?? "User";

        // ðŸš¨ Handle role change dynamically
        if (!_isLoggedIn || !_userRole.Equals("Admin", StringComparison.OrdinalIgnoreCase))
        {
          Navigation.NavigateTo("/", forceLoad: true);
          return;
        }

        await InvokeAsync(StateHasChanged);
      };
    }
  }


  private void UpdateCurrentUrl(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
  {
    CurrentUrl = NavigationManager.Uri.Replace(NavigationManager.BaseUri, "/");
    StateHasChanged();
  }

  protected override void OnInitialized()
  {
    CurrentUrl = NavigationManager.Uri.Replace(NavigationManager.BaseUri, "/");
    NavigationManager.LocationChanged += UpdateCurrentUrl;
  }

  public void Dispose()
  {
    NavigationManager.LocationChanged -= UpdateCurrentUrl;
  }

  record NavItem(string Label, string Href, string Icon);

  List<NavItem> NavItems = new()
{
new("Dashboard", "/admin-dashboard", Icons.Material.Filled.Dashboard),
new("Course Management", "/admin-course", Icons.Material.Filled.Coffee),
new("Category Management", "/admin-category", Icons.Material.Filled.Category),
new("User Management", "/admin-user", Icons.Material.Filled.PermContactCalendar),
new("Payment Method", "/admin-payment", Icons.Material.Filled.Payments),
};


  private async Task Logout()
  {
    try
    {
      var result = await AuthService.LogoutAsync();
      if (result == null)
      {
        Snackbar.Add("Server tidak merespons saat logout.", Severity.Error);
        return;
      }

      if (result.Success)
      {
        // Pastikan nama variabel local storage sesuai dengan DI (perhatikan huruf besar kecil)
        await LocalStorage.RemoveItemAsync("authToken");
        await LocalStorage.RemoveItemAsync("accessToken");
        await LocalStorage.RemoveItemAsync("refreshToken");
        await LocalStorage.RemoveItemAsync("expiresAt");

        if (AuthStateProvider is CustomAuthStateProvider customProvider)
          customProvider.NotifyUserLogout();

        Snackbar.Add("âœ… Logout Succes! See you later ðŸ‘‹", Severity.Success);

        await Task.Delay(800);
        Navigation.NavigateTo("/login", forceLoad: true);
      }
      else
      {
        Snackbar.Add(result.Message ?? "Logout Failed!", Severity.Error);
      }
    }
    catch (Exception ex)
    {
      Snackbar.Add($"Terjadi kesalahan: {ex.Message}", Severity.Error);
      Console.WriteLine($"Logout error: {ex}");
    }
  }
}

<style>
  .nav-btn {
    border-radius: 8px;
    text-align: left;
    padding: 10px 12px;
    transition: all 0.2s ease;
  }

  .nav-btn:hover {
    background-color: #f2f2f2;
  }

  .nav-btn.active {
    background-color: #e0e0e0;
    border-left: 4px solid #1976d2;
    /* warna biru khas Material */
    font-weight: 600;
  }
</style>