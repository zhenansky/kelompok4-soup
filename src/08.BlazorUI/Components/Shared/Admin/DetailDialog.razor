@using Blazored.LocalStorage
@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Models
@inject ILocalStorageService LocalStorage
@inject ISnackbar Snackbar
@inject InvoiceService InvoiceService

<MudDialog>
  <TitleContent>
    <MudText Typo="Typo.h6">Detail Invoice</MudText>

    <MudGrid Class="mt-4">
      <MudItem xs="12" sm="6" Class="d-flex gap-8">
        <MudItem>
          <MudText>No. Invoice:</MudText>
          <MudText>Date:</MudText>
        </MudItem>
        <MudItem>
          <MudText>@(Invoice?.NoInvoice ?? "-")</MudText>
          <MudText>
            @(Invoice?.Date != DateTime.MinValue
                        ? Invoice?.Date.ToString("dddd, dd MMMM yyyy", new System.Globalization.CultureInfo("id-ID"))
                        : "-")
          </MudText>
        </MudItem>
      </MudItem>

      <MudItem xs="12" sm="6" Class="d-flex justify-end align-end gap-8">
        <MudText Typo="Typo.body1" Style="font-weight:700;">Total Price</MudText>
        <MudText Typo="Typo.body1" Style="font-weight:700;">
          @("IDR " + (Invoice?.TotalPrice ?? 0).ToString("N0", new System.Globalization.CultureInfo("id-ID")))
        </MudText>
      </MudItem>
    </MudGrid>
  </TitleContent>

  <DialogContent>
    <MudTable Items="InvoiceItems" FixedHeader="true" Hover="true" Breakpoint="Breakpoint.Sm" Loading="_loading">
      <HeaderContent>
        <MudTh>No</MudTh>
        <MudTh>Course Name</MudTh>
        <MudTh>Type</MudTh>
        <MudTh>Schedule</MudTh>
        <MudTh>Price</MudTh>
      </HeaderContent>

      <RowTemplate>
        <MudTd>@context.No</MudTd>
        <MudTd>@context.CourseName</MudTd>
        <MudTd>@context.Type</MudTd>
        <MudTd>
          @context.Schedule.ToString("dddd, dd MMMM yyyy", new System.Globalization.CultureInfo("id-ID"))
        </MudTd>
        <MudTd>
          @("IDR " + context.Price.ToString("N0", new System.Globalization.CultureInfo("id-ID")))
        </MudTd>
      </RowTemplate>

      <NoRecordsContent>
        <MudText Class="m-3">Tidak ada data kursus untuk invoice ini.</MudText>
      </NoRecordsContent>
    </MudTable>
  </DialogContent>

  <DialogActions>
    <MudButton Color="Color.Primary" OnClick="CloseDialog">OK</MudButton>
  </DialogActions>
</MudDialog>

@code {
  [Parameter] public int InvoiceId { get; set; }
  [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;

  private bool _loading = false;
  private InvoiceDetailData? Invoice;
  private List<CourseItem> InvoiceItems = new();
  protected override async Task OnInitializedAsync()
  {
    await LoadInvoiceAsync();
  }

  private async Task LoadInvoiceAsync()
  {
    _loading = true;
    try
    {
      var token = await LocalStorage.GetItemAsync<string>("accessToken");

      if (string.IsNullOrEmpty(token))
      {
        Snackbar.Add("âš ï¸ Token tidak ditemukan, silakan login kembali.", Severity.Warning);
        _loading = false;
        return;
      }

      Console.WriteLine($"ðŸªª Token ditemukan: {token.Substring(0, Math.Min(token.Length, 15))}...");

      Invoice = await InvoiceService.GetInvoiceDetailAsync(InvoiceId, token);

      if (Invoice == null)
      {
        Snackbar.Add("âŒ Gagal memuat detail invoice.", Severity.Error);
        _loading = false;
        return;
      }

      InvoiceItems = Invoice.ListCourse?.Select((c, i) => new CourseItem
      {
        No = i + 1,
        CourseName = c.Name,
        Type = c.Category,
        Schedule = c.ScheduleDate,
        Price = c.Price
      }).ToList() ?? new List<CourseItem>();

    }
    catch (Exception ex)
    {
      Snackbar.Add($"âŒ Error loading invoice: {ex.Message}", Severity.Error);
      Console.WriteLine($"âŒ Error detail: {ex}");
    }

    _loading = false;
  }

  private void CloseDialog() => MudDialog.Close(DialogResult.Ok(true));

  private class CourseItem
  {
    public int No { get; set; }
    public string CourseName { get; set; } = string.Empty;
    public string Type { get; set; } = string.Empty;
    public DateTime Schedule { get; set; }
    public decimal Price { get; set; }
  }
}