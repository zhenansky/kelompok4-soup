@using Blazored.LocalStorage
@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Models
@inject ILocalStorageService LocalStorage
@inject ISnackbar Snackbar
@inject InvoiceService InvoiceService

<MudDialog>
  <TitleContent>
    <MudText Typo="Typo.h6">Detail Invoice</MudText>
  </TitleContent>

  <DialogContent>
    <MudGrid Class="mt-4 mb-4">
      <MudItem xs="12" sm="6" Class="d-flex gap-8">
        <MudItem>
          <MudText>No. Invoice:</MudText>
          <MudText>Date:</MudText>
        </MudItem>
        <MudItem>
          <MudText>@(InvoiceDetail?.NoInvoice ?? "-")</MudText>
          <MudText>
            @(InvoiceDetail?.Date != DateTime.MinValue
                        ? InvoiceDetail?.Date.ToString("dddd, dd MMMM yyyy")
                        : "-")
          </MudText>
        </MudItem>
      </MudItem>

      <MudItem xs="12" sm="6" Class="d-flex justify-end align-end gap-8">
        <MudText Typo="Typo.body1" Style="font-weight:700;">Total Price</MudText>
        <MudText Typo="Typo.body1" Style="font-weight:700;">
          @("IDR " + (InvoiceDetail?.TotalPrice ?? 0).ToString("N0", new System.Globalization.CultureInfo("id-ID")))
        </MudText>
      </MudItem>
    </MudGrid>

    <MudTable Items="InvoiceItems" FixedHeader="true" Hover="true" Breakpoint="Breakpoint.Sm" Loading="_loading">
      <HeaderContent>
        <MudTh>No</MudTh>
        <MudTh>Course Name</MudTh>
        <MudTh>Type</MudTh>
        <MudTh>Schedule</MudTh>
        <MudTh>Price</MudTh>
      </HeaderContent>

      <RowTemplate>
        <MudTd>@context.No</MudTd>
        <MudTd>@context.CourseName</MudTd>
        <MudTd>@context.Type</MudTd>
        <MudTd>
          @context.Schedule.ToString("dddd, dd MMMM yyyy", new System.Globalization.CultureInfo("id-ID"))
        </MudTd>
        <MudTd>
          @("IDR " + context.Price.ToString("N0", new System.Globalization.CultureInfo("id-ID")))
        </MudTd>
      </RowTemplate>

      <NoRecordsContent>
        <MudText Class="m-3">Tidak ada data kursus untuk invoice ini.</MudText>
      </NoRecordsContent>
    </MudTable>

    @if (_loading)
    {
      <MudProgressCircular Indeterminate="true" Color="Color.Primary" Class="mx-auto my-4" />
    }

  </DialogContent>

  <DialogActions>
    <MudButton Color="Color.Primary" OnClick="CloseDialog">OK</MudButton>
  </DialogActions>
</MudDialog>

@code {
  [Parameter] public int InvoiceId { get; set; }
  [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;

  private bool _loading = false;
  private InvoiceDetailData? InvoiceDetail;
  private List<CourseItem> InvoiceItems = new();

  protected override async Task OnParametersSetAsync()
  {
    if (InvoiceId <= 0)
    {
      Console.WriteLine("âš ï¸ InvoiceId belum valid, skip load.");
      return;
    }

    await LoadInvoiceAsync();
  }

  private async Task LoadInvoiceAsync()
  {
    _loading = true;
    try
    {
      var token = await LocalStorage.GetItemAsync<string>("accessToken");

      if (string.IsNullOrEmpty(token))
      {
        Snackbar.Add("âš ï¸ Token tidak ditemukan, silakan login kembali.", Severity.Warning);
        return;
      }

      InvoiceDetail = await InvoiceService.GetInvoiceDetailAsync(InvoiceId, token);

      if (InvoiceDetail == null)
      {
        Snackbar.Add("âŒ Gagal memuat detail invoice.", Severity.Error);
        return;
      }

      // ðŸ”¹ Setelah data diterima, buat daftar item
      InvoiceItems = InvoiceDetail.ListCourse?.Select((c, i) => new CourseItem
      {
        No = i + 1,
        CourseName = c.Name,
        Type = c.Category,
        Schedule = c.ScheduleDate,
        Price = c.Price
      }).ToList() ?? new List<CourseItem>();

      Console.WriteLine($"âœ… Invoice loaded: {InvoiceDetail.NoInvoice}, items: {InvoiceItems.Count}");

      // âœ… Tambahkan ini supaya TitleContent ikut di-render ulang
      StateHasChanged();
    }
    catch (Exception ex)
    {
      Snackbar.Add($"âŒ Error loading invoice: {ex.Message}", Severity.Error);
      Console.WriteLine($"âŒ Error detail: {ex}");
    }
    finally
    {
      _loading = false;
      StateHasChanged(); // tetap biar loading spinner hilang
    }
  }

  private void CloseDialog() => MudDialog.Close(DialogResult.Ok(true));

  private class CourseItem
  {
    public int No { get; set; }
    public string CourseName { get; set; } = string.Empty;
    public string Type { get; set; } = string.Empty;
    public DateTimeOffset Schedule { get; set; }
    public decimal Price { get; set; }
  }
}