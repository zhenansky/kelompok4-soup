@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Models
@inject InvoiceService InvoiceService
@inject ISnackbar Snackbar

<MudDialog>
  <TitleContent>
    <MudText Typo="Typo.h6">Detail Invoice</MudText>
    <MudGrid>
      <MudItem xs="12" sm="6" Class="mt-5 d-flex gap-8">
        <MudItem>
          <MudText>No. Invoice: </MudText>
          <MudText>Date: </MudText>
        </MudItem>
        <MudItem>
          <MudText>@Invoice?.NoInvoice</MudText>
          <MudText>@Invoice?.Date.ToString("dddd, dd MMMM yyyy")</MudText>
        </MudItem>
      </MudItem>

      <MudItem xs="12" sm="6" Class="mt-5 d-flex justify-end align-end gap-8">
        <MudText Typo="Typo.body1" Style="font-weight: 700;">Total Price</MudText>
        <MudText Typo="Typo.body1" Style="font-weight: 700;">
          @("IDR " + Invoice?.TotalPrice.ToString("N0", new System.Globalization.CultureInfo("id-ID")))
        </MudText>
      </MudItem>
    </MudGrid>
  </TitleContent>

  <DialogContent>
    <MudTable Items="@InvoiceItems" FixedHeader="true" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading">
      <HeaderContent>
        <MudTh>No</MudTh>
        <MudTh>Course Name</MudTh>
        <MudTh>Type</MudTh>
        <MudTh>Schedule</MudTh>
        <MudTh>Price</MudTh>
      </HeaderContent>
      <RowTemplate>
        <MudTd>@context.No</MudTd>
        <MudTd>@context.CourseName</MudTd>
        <MudTd>@context.Type</MudTd>
        <MudTd>@context.Schedule.ToString("dddd, dd MMMM yyyy")</MudTd>
        <MudTd>@("IDR " + context.Price.ToString("N0", new System.Globalization.CultureInfo("id-ID")))</MudTd>
      </RowTemplate>
    </MudTable>
  </DialogContent>

  <DialogActions>
    <MudButton Color="Color.Primary" OnClick="Submit">OK</MudButton>
  </DialogActions>
</MudDialog>

@code {
  [Parameter]
  public string Token { get; set; } = string.Empty;
  [Parameter] public int InvoiceId { get; set; }
  [CascadingParameter] private IMudDialogInstance MudDialog { get; set; }

  private bool _loading;
  private InvoiceDetailModel? Invoice;
  private List<CourseItem> InvoiceItems = new();

  protected override async Task OnInitializedAsync() => await LoadInvoiceAsync();

  private async Task LoadInvoiceAsync()
  {
    _loading = true;

    try
    {
      // Token sementara
      var token =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZW1haWwiOiJhZG1pbkBlbWFpbC5jb20iLCJuYW1lIjoiQWRtaW4iLCJzdGF0dXMiOiJBY3RpdmUiLCJqdGkiOiI4NmM2ODBmMC1lY2E1LTQzMmMtYjJkNi1iYmY2N2Q5ZTMxOWMiLCJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dzLzIwMDgvMDYvaWRlbnRpdHkvY2xhaW1zL3JvbGUiOiJBZG1pbiIsImV4cCI6MTc2MDk0NjIzNCwiaXNzIjoiTXlBcHAiLCJhdWQiOiJNeUFwcFVzZXJzIn0.xkIk73GPvcobuxSxGtH1ua4zScbEQjLTjr821SHS-kY";

      Invoice = await InvoiceService.GetInvoiceDetailAsync(InvoiceId, token);

      // Jika backend belum ada data Courses â†’ buat dummy list kosong supaya tidak error
      if (Invoice?.Courses == null)
        Invoice!.Courses = new List<InvoiceCourseModel>();

      if (Invoice.Courses.Any())
      {
        InvoiceItems = Invoice.Courses.Select((c, i) => new CourseItem
        {
          No = i + 1,
          CourseName = c.CourseName,
          Type = c.Type,
          Schedule = c.Schedule,
          Price = c.Price
        }).ToList();
      }
    }
    catch (Exception ex)
    {
      Snackbar.Add($"Error loading invoice: {ex.Message}", Severity.Error);
    }

    _loading = false;
  }

  private void Submit() => MudDialog.Close(DialogResult.Ok(true));

  private class CourseItem
  {
    public int No { get; set; }
    public string CourseName { get; set; } = string.Empty;
    public string Type { get; set; } = string.Empty;
    public DateTime Schedule { get; set; }
    public decimal Price { get; set; }
  }
}