@using MyApp.BlazorUI.Services
<MudDialog>
  <TitleContent>
    <MudText Typo="Typo.h6">Add User</MudText>
  </TitleContent>

  <DialogContent>
    <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors">
      <MudPaper Elevation="0" Class="d-flex flex-column gap-6">
        <MudTextField T="string" @bind-Value="User.Name" Placeholder="Name" Variant="Variant.Outlined" Required="true"
          RequiredError="Name is required!" For="@(() => User.Name)" Style="height: 2rem;" />

        <MudTextField T="string" @bind-Value="User.Email" Placeholder="Email" Variant="Variant.Outlined"
          InputType="InputType.Email" Required="true" RequiredError="Email is required!" Validation="ValidateEmail"
          For="@(() => User.Email)" Style="height: 2rem;" />

        <MudTextField T="string" @bind-Value="User.Password" Placeholder="Password" Variant="Variant.Outlined"
          InputType="@PasswordInput" Adornment="Adornment.End" AdornmentIcon="@PasswordInputIcon"
          OnAdornmentClick="TogglePassword" AdornmentAriaLabel="Show Password" IconSize="Size.Small" Required="true"
          RequiredError="Password is required!" Validation="ValidatePassword" For="@(() => User.Password)"
          Style="height: 2rem;" />

        <MudText>Role:</MudText>
        <MudRadioGroup @bind-Value="User.Role" required For="@(() => User.Role)">
          <MudRadio Value="@UserRole.Admin" Color="Color.Warning">Admin</MudRadio>
          <MudRadio Value="@UserRole.User" Color="Color.Warning">User</MudRadio>
        </MudRadioGroup>

        <MudText>Status:</MudText>
        <MudRadioGroup @bind-Value="User.Status" required For="@(() => User.Status)">
          <MudRadio Value="@UserStatus.Active" Color="Color.Success">Active</MudRadio>
          <MudRadio Value="@UserStatus.Inactive" Color="Color.Error">Inactive</MudRadio>
        </MudRadioGroup>

        @if (!string.IsNullOrEmpty(addUserError))
        {
          <MudText Color="Color.Error">@addUserError</MudText>
        }
      </MudPaper>
    </MudForm>
  </DialogContent>

  <DialogActions>
    <MudButton OnClick="Cancel" Variant="Variant.Outlined" Class="rounded-lg">Cancel</MudButton>
    <MudButton OnClick="Submit" Variant="Variant.Filled" Class="rounded-lg"
      Style="background-color:green; color: white;">Submit</MudButton>
  </DialogActions>
</MudDialog>

@code {
  [CascadingParameter] private IMudDialogInstance MudDialog { get; set; }

  [Inject] private UserService UserService { get; set; }

  private bool success;
  private string[] errors = Array.Empty<string>();
  private MudForm? form;
  private string addUserError = string.Empty;

  private UserModel User = new()
  {
    Role = UserRole.User,
    Status = UserStatus.Active
  };

  private bool isShow;
  private InputType PasswordInput = InputType.Password;
  private string PasswordInputIcon = Icons.Material.Filled.VisibilityOff;

  private async Task Submit()
  {
    form?.Validate();
    if (!success) return;

    try
    {
      bool result = await UserService.CreateUserAsync(User); // atau UpdateUserAsync untuk edit
      if (result)
      {
        // Tutup dialog dengan DialogResult.Ok(true)
        MudDialog.Close(DialogResult.Ok(true));
      }
      else
      {
        addUserError = "Gagal menambahkan user!";
      }
    }
    catch (Exception ex)
    {
      addUserError = $"Error: {ex.Message}";
    }
  }

  private void Cancel()
  {
    // Tutup dialog dengan cancel
    MudDialog.Cancel();
  }

  private string ValidateEmail(string value)
  {
    if (string.IsNullOrWhiteSpace(value))
      return "Email is required!";
    if (!System.Text.RegularExpressions.Regex.IsMatch(value, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
      return "Invalid email format!";
    return string.Empty;
  }

  private IEnumerable<string> ValidatePassword(string value)
  {
    if (string.IsNullOrWhiteSpace(value))
    {
      yield return "Password is required!";
      yield break;
    }
    if (value.Length < 6 || !Regex.IsMatch(value, @"[A-Z]") || !Regex.IsMatch(value, @"[0-9]"))
    {
      yield return "Password must be at least 6 characters, contain one uppercase letter and one number!";
    }
  }

  private void TogglePassword()
  {
    isShow = !isShow;
    PasswordInput = isShow ? InputType.Text : InputType.Password;
    PasswordInputIcon = isShow ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
  }
}