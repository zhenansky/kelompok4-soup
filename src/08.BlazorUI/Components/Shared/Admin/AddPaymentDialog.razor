@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Components.Models

<MudDialog>
  <TitleContent>
    <MudText Typo="Typo.h6">Add Payment</MudText>
  </TitleContent>
  <DialogContent>
    <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors">
      <MudTextField T="string" @bind-Value="Payment.Name" Placeholder="Name" Variant="Variant.Outlined" Required="true"
        RequiredError="Name is required!" />
      <MudText Typo="Typo.body1">Upload Logo:</MudText>
      <InputFile OnChange="OnLogoSelected" accept="image/*" />
      @if (!string.IsNullOrEmpty(Payment.Logo))
      {
        <MudImage Src="@Payment.Logo" Width="50" Height="50" Class="mt-2" />
      }

      <MudRadioGroup T="PaymentStatus" @bind-Value="Payment.Status" required>
        <MudRadio T="PaymentStatus" Value=PaymentStatus.Active Color="Color.Success">Active</MudRadio>
        <MudRadio T="PaymentStatus" Value=PaymentStatus.Inactive Color="Color.Error">Inactive</MudRadio>
      </MudRadioGroup>

      @if (!string.IsNullOrEmpty(paymentError))
      {
        <MudText Color="Color.Error">@paymentError</MudText>
      }
    </MudForm>
  </DialogContent>
  <DialogActions>
    <MudButton OnClick="Cancel" Variant="Variant.Outlined">Cancel</MudButton>
    <MudButton OnClick="SubmitAsync" Variant="Variant.Filled" Style="background-color:green; color:white;">Submit
    </MudButton>
  </DialogActions>
</MudDialog>

@code {
  [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
  [Inject] private IWebHostEnvironment Env { get; set; } = default!;
  [Inject] private PaymentService PaymentService { get; set; } = default!;

  bool success;
  string[] errors = { };
  MudForm? form;
  private string paymentError = string.Empty;
  private PaymentModel Payment = new() { Status = PaymentStatus.Active };

  private void Cancel() => MudDialog.Cancel();

  private async Task OnLogoSelected(InputFileChangeEventArgs e)
  {
    var file = e.File;
    var fileName = $"{Guid.NewGuid()}{Path.GetExtension(file.Name)}";
    var savePath = Path.Combine(Env.WebRootPath, "images", "payment", fileName);
    Directory.CreateDirectory(Path.GetDirectoryName(savePath)!);
    await using var fs = new FileStream(savePath, FileMode.Create);
    await file.OpenReadStream(2_000_000).CopyToAsync(fs);
    Payment.Logo = $"/images/payment/{fileName}";
    StateHasChanged();
  }

  private async Task SubmitAsync()
  {
    form?.Validate();
    if (!success) return;

    try
    {
      await PaymentService.CreatePaymentAsync(Payment);
      MudDialog.Close(DialogResult.Ok(true));
    }
    catch (Exception ex)
    {
      paymentError = $"Failed to create payment method: {ex.Message}";
    }
  }
}