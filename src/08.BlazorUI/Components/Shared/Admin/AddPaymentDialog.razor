@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Components.Models
@inject PaymentService PaymentService

<MudDialog>
  <TitleContent>
    <MudText Typo="Typo.h6">Add Payment</MudText>
  </TitleContent>

  <DialogContent>
    <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors">
      <MudTextField T="string" @bind-Value="Payment.Name" Placeholder="Name" Variant="Variant.Outlined" Required="true"
        RequiredError="Name is required!" />

      <MudText Typo="Typo.body1" Class="mt-3">Upload Logo:</MudText>
      <InputFile OnChange="OnLogoSelected" accept="image/*" />
      @if (LogoPreview != null)
      {
        <MudImage Src="@LogoPreview" Width="60" Height="60" Class="mt-2" />
      }

      <MudRadioGroup T="PaymentStatus" @bind-Value="Payment.Status" Required>
        <MudRadio T="PaymentStatus" Value="PaymentStatus.Active" Color="Color.Success">Active</MudRadio>
        <MudRadio T="PaymentStatus" Value="PaymentStatus.Inactive" Color="Color.Error">Inactive</MudRadio>
      </MudRadioGroup>

      @if (!string.IsNullOrEmpty(paymentError))
      {
        <MudText Color="Color.Error">@paymentError</MudText>
      }
    </MudForm>
  </DialogContent>

  <DialogActions>
    <MudButton OnClick="Cancel" Variant="Variant.Outlined">Cancel</MudButton>
    <MudButton OnClick="SubmitAsync" Variant="Variant.Filled" Style="background-color:green; color:white;">Submit
    </MudButton>
  </DialogActions>
</MudDialog>

@code {
  [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;

  private MudForm? form;
  private bool success;
  private string[] errors = Array.Empty<string>();
  private string paymentError = string.Empty;

  private PaymentModel Payment = new() { Status = PaymentStatus.Active };
  private IBrowserFile? LogoFile;
  private string? LogoPreview;

  private void Cancel() => MudDialog.Cancel();

  private async Task OnLogoSelected(InputFileChangeEventArgs e)
  {
    LogoFile = e.File;

    // buat preview di UI
    var buffer = new byte[LogoFile.Size];
    await LogoFile.OpenReadStream().ReadAsync(buffer);
    LogoPreview = $"data:{LogoFile.ContentType};base64,{Convert.ToBase64String(buffer)}";

    StateHasChanged();
  }

  private async Task SubmitAsync()
  {
    await form!.Validate();
    if (!success) return;

    if (LogoFile == null)
    {
      paymentError = "Please upload a logo before submitting.";
      return;
    }

    try
    {
      await PaymentService.CreatePaymentAsync(Payment, LogoFile);
      MudDialog.Close(DialogResult.Ok(true));
    }
    catch (Exception ex)
    {
      paymentError = $"Failed to create payment method: {ex.Message}";
    }
  }
}