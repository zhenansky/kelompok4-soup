@using MudBlazor
@using MyApp.BlazorUI.Components.Models
@using MyApp.BlazorUI.DTOs
@inject HttpClient Http
@inject HttpClient Http

<MudDialog>
  <TitleContent>
    <MudText Typo="Typo.h6">Select Payment Method</MudText>
  </TitleContent>
  <DialogContent>
    
    @* --- KONTEN DIUBAH UNTUK MENANGANI LOADING & ERROR --- *@
    @if (_isLoading)
    {
        <MudGrid Justify="Justify.Center" Class="pa-10">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </MudGrid>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudText Color="Color.Error" Align="Align.Center">@_errorMessage</MudText>
    }
    else
    {
        <MudStack Spacing="2">
            @* Loop diubah untuk menggunakan list baru 'ApiPaymentMethods' *@
            @foreach (var method in ApiPaymentMethods)
            {
                <MudItem>
                    <MudPaper Elevation="0"
                              Class=@($"d-flex justify-start gap-6 {(SelectedMethod == method.Id ? "selected-method" : "")}")>
                        <MudButton class="d-flex justify-start" Style="width: 100%;" OnClick="@(() => SetSelectedMethod(method.Id))">
                            <MudImage Src="@method.Logo" Class="mr-4" Width="40" Height="40" />
                            <MudText Style="font-weight: 500; font-size: 18px;">@method.Name</MudText>
                        </MudButton>
                    </MudPaper>
                </MudItem>
            }
        </MudStack>
    }
    @* --- AKHIR PERUBAHAN KONTEN --- *@

  </DialogContent>

  <DialogActions>
    <MudButton Variant="Variant.Outlined" OnClick="Cancel" Class="button button-outline rounded-lg">
      Cancel
    </MudButton>
    <MudButton Variant="Variant.Filled"
               OnClick="ConfirmPayNow"
               DropShadow="false"
               Disabled="@(SelectedMethod is null || _isLoading)" @* <-- Ditambahkan disable saat loading *@
               Class="button button-filled rounded-lg">
      Pay Now
    </MudButton>
  </DialogActions>
</MudDialog>

@code {
  [CascadingParameter] IMudDialogInstance MudDialogObj { get; set; } = default!;

  private int? SelectedMethod { get; set; }

  // ==========================================================
  // == PERUBAHAN: Mengambil data dari API ==
  // ==========================================================

  // 1. Variabel state baru
  private List<PaymentModel> ApiPaymentMethods { get; set; } = new List<PaymentModel>();
  private bool _isLoading = true;
  private string? _errorMessage;

  protected override async Task OnInitializedAsync()
  {
      _isLoading = true;
      try
      {
          // Asumsi Anda memiliki model "ApiResponse<T>" yang sama dengan file lain
          // Ganti "api/paymentmethods" dengan endpoint API Anda yang sebenarnya
          var response = await Http.GetFromJsonAsync<ApiResponse<List<PaymentModel>>>("api/paymentmethods");

          if (response?.Success == true && response.Data != null)
          {
              // Kita tetap filter berdasarkan status 'Active' seperti logika Anda sebelumnya
              ApiPaymentMethods = response.Data.Where(p => p.Status == PaymentStatus.Active).ToList();

              if (!ApiPaymentMethods.Any())
              {
                  _errorMessage = "Tidak ada metode pembayaran yang tersedia saat ini.";
              }
          }
          else
          {
              _errorMessage = response?.Message ?? "Gagal memuat metode pembayaran.";
          }
      }
      catch (Exception ex)
      {
          // Tangani error jika API tidak terjangkau
          _errorMessage = $"Terjadi kesalahan koneksi: {ex.Message}";
      }
      finally
      {
          _isLoading = false;
      }
  }
  
  // ==========================================================
  // == FUNGSI DI BAWAH INI TIDAK BERUBAH SAMA SEKALI ==
  // ==========================================================

  private void SetSelectedMethod(int method) => SelectedMethod = method;

  private void Cancel() => MudDialogObj.Cancel();

  private void ConfirmPayNow()
  {
      if (SelectedMethod is null)
      {
          MudDialogObj.Cancel();
          return;
      }

      // Kirim hasil (ID metode yang dipilih) kembali ke CheckOut.razor
      MudDialogObj.Close(DialogResult.Ok(SelectedMethod.Value));
  }
}

<style>
  /* Style Anda (tidak berubah) */
  .selected-method {
    background-color: #FABC1D;
  }

  .mud-dialog-actions {
    justify-content: space-between !important;
    margin: 1rem;
    gap: 12px;
  }

  .mud-dialog-title {
    text-align: center;
    width: 100%;
    font-weight: 600;
  }

  .mud-dialog {
    max-width: 400px !important;
    width: 90% !important;
  }
</style>