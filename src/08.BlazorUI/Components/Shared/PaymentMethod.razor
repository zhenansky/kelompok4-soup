@using MudBlazor
@using MyApp.BlazorUI.Components.Models
@using MyApp.BlazorUI.Services
@inject IConfiguration Configuration
@inject PaymentService PaymentService
@inject ISnackbar Snackbar


<MudDialog>
  <TitleContent>
    <MudText Typo="Typo.h6">Select Payment Method</MudText>
  </TitleContent>

  <DialogContent>
   @if (_loading)
    {
      <div class="d-flex align-items-center justify-content-center">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
      </div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
      <div class="d-flex align-items-center justify-content-center">
        <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
      </div>
    }
    else
    {
      <MudStack Spacing="2">
        @foreach (var method in Payments)
        {
          @if(method.Status == PaymentStatus.Active)
          {
            <MudItem>
              <MudPaper Elevation="0"
                Class=@($"d-flex justify-start gap-6 {(SelectedMethod == method.Id ? "selected-method" : "")}")>
                <MudButton class="d-flex justify-start" Style="width: 100%;" OnClick="@(() => SetSelectedMethod(method.Id))">
                  <MudImage Src="@($"{Configuration["ApiBaseUrl"]}/payment-logos/{method.Logo}")" Class="mr-4" Width="40" Height="40" />
                  <MudText Style="font-weight: 500; font-size: 18px;">@method.Name</MudText>
                </MudButton>
              </MudPaper>
            </MudItem>
          }
        }
      </MudStack>
    }
  </DialogContent>

  <DialogActions>
    <MudButton Variant="Variant.Outlined" OnClick="Cancel" Class="button button-outline rounded-lg">
      Cancel
    </MudButton>
    <MudButton Variant="Variant.Filled" OnClick="ConfirmPayNow" DropShadow="false"
      Disabled="@(SelectedMethod == null)" Class="button button-filled rounded-lg">
      Pay Now
    </MudButton>
  </DialogActions>
</MudDialog>

@code {
  [CascadingParameter] IMudDialogInstance? MudDialogObj { get; set; }
  private List<PaymentModel> Payments = new List<PaymentModel>();
  private int? SelectedMethod { get; set; }
  private bool _loading;
  private string? _errorMessage;

  protected override async Task OnInitializedAsync()
  {
    await LoadPaymentsAsync();
  }

  private async Task LoadPaymentsAsync()
  {
    _loading = true;
    try
    {
      Payments = await PaymentService.GetPaymentsAsync();
    }
    catch (Exception ex)
    {
      Console.WriteLine($"âŒ Failed to load payments: {ex.Message}");
      _errorMessage = "Gagal memuat metode pembayaran.";
    }
    finally
    {
      _loading = false;
      StateHasChanged();
    }
  }


  private void SetSelectedMethod(int method) => SelectedMethod = method;

  private void SelectMethod(int? method)
  {
    if (MudDialogObj is not null)
    {
      try { 
        MudDialogObj.Close(DialogResult.Ok(method)); 
      } catch(Exception ex) {
        Snackbar.Add("Gagal membayar.", Severity.Error);
        Console.WriteLine($"error pay: {ex}");
      }
    }
  }

  private void Cancel() => MudDialogObj.Cancel();


  private void ConfirmPayNow()
  {
    if (SelectedMethod == null)
    {
      Snackbar.Add("Pilih metode pembayaran.", Severity.Info);
      return;
    }

    SelectMethod(SelectedMethod);
  }
}

<style>
  .selected-method {
    background-color: #FABC1D;
  }

  .mud-dialog-actions {
    justify-content: space-between !important;
    margin: 1rem;
    gap: 12px;
  }

  .mud-dialog-title {
    text-align: center;
    width: 100%;
    font-weight: 600;
  }

  .mud-dialog {
    max-width: 400px !important;
    width: 90% !important;
  }
</style>