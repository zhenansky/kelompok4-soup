@page "/my-class"
@using Blazored.LocalStorage
@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Models
@using MyApp.BlazorUI.Services.Interfaces
@using MyApp.BlazorUI.Components.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject MyClassServices MyClassServices
@inject ILocalStorageService LocalStorage
@inject IConfiguration Config


<PageTitle>My Class</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="pa-4 container">

  @if (_loading)
  {
    <div class="d-flex align-items-center justify-content-center" style="height: 100vh;">
      <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
      <MudText Typo="Typo.h6" Class="ml-3">Loading...</MudText>
    </div>
  }
  else
  {
    <MudPaper Elevation="0" Class="pa-4">
      @foreach (var mc in myClasses)
      {
        <MudGrid Class="my-3 align-center" @key="mc">

          <MudItem xs="12" sm="4" md="2">
            <MudImage Src="@($"{Config["ApiBaseUrl"]}/{mc.Image}")" Alt="@mc.Name" Fluid="true" />
          </MudItem>
          <MudItem xs="10" sm="6" md="8">
            <div class="d-flex flex-column">
              <MudText Typo="Typo.caption" style="color: #828282;">@mc.Category</MudText>
              <MudText Typo="Typo.h6" style="font-weight: 600;">@mc.Name</MudText>
              <MudText Typo="Typo.subtitle1" Class="mt-1" style="color: #FABC1D; font-weight: 500;">
                Schedule: @mc.Schedule.ToString("dddd, dd MMMM yyyy")
              </MudText>
            </div>
          </MudItem>
        </MudGrid>
        <MudDivider Class="my-2" Style="border: 1px solid rgba(0,0,0,0.77);" />
      }
    </MudPaper>
    @if (myClasses.Count() < 1)
    {
      <MudText Class="d-flex justify-center" Style="font-weight: 600; font-size: 24px;">No course found.</MudText>
    }
  }
</MudContainer>

@code {
  private bool _loading;
  private bool _loaded;
  private int totalMyClass;
  private List<MyClassData> myClasses = new();

  protected override async Task OnInitializedAsync()
  {
    _loading = true;
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender || _loaded)
      return;

    _loading = true;

    try
    {
      var authState = await AuthService.IsUserAuthenticatedAsync();
      if (!authState)
      {
        Navigation.NavigateTo("/", forceLoad: true);
      }

      // 2Ô∏è‚É£ Coba baca token dari LocalStorage
      string? token = null;
      try
      {
        token = await LocalStorage.GetItemAsync<string>("accessToken");
      }
      catch (Exception ex)
      {
        Console.WriteLine("‚ö†Ô∏è LocalStorage belum siap atau tidak tersedia: " + ex.Message);
      }

      // 3Ô∏è‚É£ Kalau token ada, ambil data invoice
      if (!string.IsNullOrWhiteSpace(token))
      {
        Console.WriteLine("üîë Token ditemukan, ambil data My Class...");

        myClasses = (await MyClassServices.GetMyClassAsync(token))
        .OrderByDescending(i => i.Schedule)
        .ToList();

        totalMyClass = myClasses?.Count ?? 0;
        Console.WriteLine($"üì¶ Jumlah My Class diterima: {totalMyClass}");
      }
      else
      {
        myClasses.Clear();
        totalMyClass = 0;
        Console.WriteLine("üö´ Token tidak tersedia: skip memuat My Class.");
      }

      _loaded = true;
      StateHasChanged(); // ‚¨ÖÔ∏è Pastikan UI refresh setelah data terload
    }
    catch (Exception ex)
    {
      Console.WriteLine($"‚ùå My Classes error: {ex}");
    }
    finally
    {
      _loading = false;
      StateHasChanged();
    }
  }
}