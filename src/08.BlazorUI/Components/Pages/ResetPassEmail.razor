@page "/reset-password"
@using MyApp.BlazorUI.Services.Interfaces
@using MyApp.BlazorUI.DTOs.Auth
@inject IAuthService AuthService
@inject NavigationManager Navigation

@inject ISnackbar Snackbar
@inject IAuthService AuthService


<PageTitle>Reset Password</PageTitle>

<MudContainer Class="d-flex flex-column gap-15 align-center"
  Style="max-height: calc(100vh - 5.375rem); color: #5B4947; margin: 9rem auto;">

  <MudPaper Elevation="0" Class="d-flex flex-column gap-10" Style="width: 100%; max-width: 38.5rem;">
    <MudPaper Elevation="0" Class="d-flex flex-column gap-4" Style="color: #5B4947;">
      <MudText Typo="Typo.h5" Style="font-weight: 400;">Reset Password</MudText>
      <MudText Typo="Typo.body1" Style="font-weight: 400;">Send OTP code to your email address</MudText>
    </MudPaper>

    <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors">
      <MudPaper Elevation="0" Class="d-flex flex-column gap-6">
        <MudTextField T="string" @bind-Value="forgotPasswordRequestDto.Email"
          Validation="@(new Func<string, string>(ValidateEmail))" Placeholder="Email" Variant="Variant.Outlined"
          InputType="InputType.Email" Required="true" RequiredError="Email is required!"
          For="@(() => forgotPasswordRequestDto.Email)" Style="height: 2rem;" />

        @if (!string.IsNullOrEmpty(ForgotError))
        {
          <MudText Color="Color.Error">@ForgotError</MudText>
        }
      </MudPaper>
    </MudForm>

    <MudPaper Elevation="0" Class="d-flex justify-end gap-6">
      <MudLink Href="/login">
        <MudButton Variant="Variant.Outlined" Class="rounded-lg button button-outline">
          Cancel
        </MudButton>
      </MudLink>

      <MudButton Disabled="@_processing" OnClick="Submit" Variant="Variant.Filled" DropShadow="false"
        Class="rounded-lg button button-filled">
        @if (_processing)
        {
          <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
          <MudText Class="ms-2">Processing</MudText>
        }
        else
        {
          <MudText>Confirm</MudText>
        }
      </MudButton>
    </MudPaper>
  </MudPaper>

</MudContainer>

@code {
  MudForm? form;
  bool success;
  string[] errors = { };
  private bool _processing = false;
  private string ForgotError = string.Empty;
  private ForgotPasswordRequestDto forgotPasswordRequestDto = new ForgotPasswordRequestDto();

  protected override async Task OnInitializedAsync()
  {
    var authState = await AuthService.IsUserAuthenticatedAsync();
    if (authState)
    {
      Navigation.NavigateTo("/", forceLoad: true);
    }
  }

  private async Task Submit()
  {
    form?.Validate();

    if (!success)
      return;

    _processing = true;
    ForgotError = string.Empty;
    StateHasChanged();

    try
    {
      var result = await AuthService.ForgotPasswordAsync(forgotPasswordRequestDto);
      if (result.Success)
      {
        ForgotError = result.Message;
        Console.WriteLine("âœ… Password reset link sent.");
        Snackbar.Add("âœ… A password reset link has been sent to your email.", Severity.Success);

        await Task.Delay(1500);
      }
      else
      {
        ForgotError = result.Message;
        Snackbar.Add("ðŸ’¥ Server error occurred. Please try again later.", Severity.Error);
      }
    }
    catch
    {
      ForgotError = $"Server error";
      Snackbar.Add("ðŸ’¥ Server error occurred. Please try again later.", Severity.Error);
    }
    finally
    {
      _processing = false;
      StateHasChanged();
    }
  }

  private string ValidateEmail(string value)
  {
    if (string.IsNullOrWhiteSpace(value))
    {
      return "Email is required.";
    }
    else if (!System.Text.RegularExpressions.Regex.IsMatch(value,
    @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
    {
      return "Invalid email format.";
    }
    else
    {
      return string.Empty;
    }
  }
}