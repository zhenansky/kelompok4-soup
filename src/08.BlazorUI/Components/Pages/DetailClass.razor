@page "/menu/detail/{Id:int}"

@using MudBlazor
@using Blazored.LocalStorage
@using Microsoft.AspNetCore.Components
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Json
@using System.Text.Json;
@using MyApp.BlazorUI.Components.Shared
@using MyApp.BlazorUI.Services.Interfaces
@using MyApp.BlazorUI.DTOs.Auth
@using MyApp.BlazorUI.DTOs
@using System.Globalization
@inject HttpClient Http
@inject IConfiguration Configuration
@inject NavigationManager NavManager
@inject MyApp.BlazorUI.Services.CartService CartService
@inject ISnackbar Snackbar
@inject IAuthService AuthService
@inject IDialogService DialogService
@inject ILocalStorageService LocalStorage
@inject MyApp.BlazorUI.Services.InvoiceService InvoiceService


@if (isLoading)
{
  <div class="d-flex align-items-center justify-content-center py-10" style="height: 100%;">
    <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
    <MudText Typo="Typo.h6" Class="ml-3">Loading...</MudText>
  </div>
}
else if (course == null)
{
  <MudGrid Justify="Justify.Center" Class="pa-10 py-10">
    <MudText Typo="Typo.h5" Color="Color.Error">Menu tidak ditemukan.</MudText>
  </MudGrid>
}
else
{
  <MudPaper Class="d-flex flex-column py-10 px-20" Elevation="0" Style="width: 100%">

    <MudPaper Class="d-flex flex-row gap-4" Style="width: 100%" Elevation="0">
      <MudImage Fluid="true" Src="@courseImageUrl" Width="400" Height="266" Alt="@course.Name" Elevation="25"
        Class="rounded-none" ObjectFit="ObjectFit.Cover" />
      <MudPaper Class="d-flex flex-column" Style="width: 100%;" Elevation="0">
        <MudText Style="color:#828282" Typo="Typo.body1">@course.CategoryName</MudText>

        <MudText Style="color:black; font-weight:600;" Typo="Typo.h5">@course.Name</MudText>
        <MudText Style="color:#5B4947; font-weight:600;" Typo="Typo.h5">
          @("IDR " + course.Price.ToString("N0", idCulture))
        </MudText>

        @* ========================================= *@
        @* KODE YANG DISESUIKAN (MudSelect Jadwal) *@
        @* ========================================= *@
        <MudSelect Style="max-width: 18.75rem;" Class="mt-6" T="int" @bind-Value="selectedScheduleId"
          Label="Select Schedule" Placeholder="Select Schedule" Variant="Variant.Outlined"
          Disabled="@(!AvailableSchedules.Any())">

          @* Tambahkan opsi "Select Schedule" dengan Value="0" sebagai default/placeholder *@
          <MudSelectItem Value="0">Select Schedule</MudSelectItem>

          @if (AvailableSchedules.Any())
          {
            @foreach (var schedule in AvailableSchedules)
            {
              // Tampilkan tanggal, gunakan Id sebagai nilai
              <MudSelectItem Value="@schedule.Id">@schedule.ScheduleDate.ToString("dddd, dd MMMM yyyy")
              </MudSelectItem>
            }
          }
          else
          {
            // Opsi jika tidak ada jadwal tersedia
            <MudSelectItem Value="0" Disabled="true">Tidak ada jadwal tersedia</MudSelectItem>
          }
        </MudSelect>

        <MudItem class="d-flex flex-row gap-4 mt-4">
          <MudButton Class="rounded-lg button button-outline" Style="width: 14.5rem;" Variant="Variant.Outlined"
            Disabled="@(selectedScheduleId == 0)" @onclick="AddToCart"> @* <-- @onclick di sini sekarang memanggil method void *@
            Add to Cart
          </MudButton>

          <MudButton Class="rounded-lg button button-filled" Style="width: 14.5rem;" Variant="Variant.Filled"
            DropShadow="false" Disabled="@(isProcessingPayment || selectedScheduleId == 0)" @onclick="BuyNow">
            @if (isProcessingPayment)
            {
              <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-2" />
              <text>Processing...</text>
            }
            else
            {
              <text>Buy Now</text>
            }
          </MudButton>
        </MudItem>
      </MudPaper>
    </MudPaper>
    <MudPaper Elevation="0" Class="d-flex flex-column mt-10 gap-4">
      <MudText Typo="Typo.h5" Style="font-weight:600">
        Description
      </MudText>
      <MudText Typo="Typo.body1">
        @course.Description
      </MudText>
    </MudPaper>
  </MudPaper>

  <MudDivider Class="my-2" Style="border-top: 2px solid rgba(0,0,0,0.77); width: 100%;" />

  <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="px-3 my-20 px-20">

    <MudText Typo="Typo.h5" Align="Align.Center" Class="fw-semibold mt-6 mb-6" Style="color:#5B4947;">
      Another menu in this class
    </MudText>
    <MudGrid Class="my-20" Gutter="3">
      @foreach (var item in OtherMenuItems)
      {

        <MudItem xs="12" sm="6" md="4" lg="4">
          <MudCard Class="h-100" Elevation="0" @onclick="() => OnOtherMenuClick(item.Id)" Style="cursor:pointer;">
            <MudCardMedia Image="@item.ImageUrl" Height="180" Class="object-cover" />

            <MudCardContent>
              <MudText Typo="Typo.caption">@item.Category</MudText>
              <MudText Typo="Typo.h6">@item.Name</MudText>

              <MudText Class="mt-4" Style="color:#FABC1D;">@item.Price</MudText>
            </MudCardContent>
          </MudCard>
        </MudItem>
      }
    </MudGrid>
  </MudContainer>
}

@code {
  [Parameter]
  public int Id { get; set; }
  private bool isProcessingPayment = false;
  string? token = null;

  private MenuCourseDto? course;
  private bool isLoading = true;
  private string courseImageUrl = string.Empty;
  private CultureInfo idCulture = new CultureInfo("id-ID");
  private string _apiBaseUrl = string.Empty;

  // --- KODE YANG DISESUIKAN ---
  private List<MenuCourseScheduleDto> AvailableSchedules = new List<MenuCourseScheduleDto>();
  private int selectedScheduleId = 0; // Tetap 0 sebagai default, yang akan menampilkan "Select Schedule"
                                      // --- AKHIR PENYESUAIAN ---

  public record OtherMenu(int Id, string Category, string Name, string Price, string ImageUrl);
  private List<OtherMenu> OtherMenuItems = new List<OtherMenu>();

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender)
      return;

    try
    {
      token = await LocalStorage.GetItemAsync<string>(key: "accessToken");
    }
    catch (Exception ex)
    {
      Console.WriteLine("‚ö†Ô∏è LocalStorage belum siap atau tidak tersedia: " + ex.Message);
    }
  }

  protected override async Task OnParametersSetAsync()
  {
    isLoading = true;
    _apiBaseUrl = (Configuration["ApiBaseUrl"] ?? "http://localhost:5099").TrimEnd('/');
    AvailableSchedules.Clear();
    selectedScheduleId = 0; // Reset ke 0 setiap kali halaman dimuat

    try
    {
      var response = await Http.GetFromJsonAsync<ApiResponse<MenuCourseDto>>($"api/menucourses/{Id}");
      if (response?.Success == true && response.Data != null)
      {
        course = response.Data;
        courseImageUrl = string.IsNullOrEmpty(course.Image) ? "" : $"{_apiBaseUrl}/{course.Image.TrimStart('/')}";

        await LoadAllSchedules(Id);

        await LoadOtherMenus(course.CategoryName, course.Id);
      }
      else
      {
        course = null;
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Gagal memuat detail menu: {ex.Message}");
      course = null;
    }
    finally
    {
      isLoading = false;
    }
  }

  private async Task LoadAllSchedules(int id)
  {
    try
    {
      var scheduleResponse = await
      Http.GetFromJsonAsync<ApiResponse<List<MenuCourseScheduleDto>>>($"api/menucourses/{id}/schedules");
      if (scheduleResponse?.Success == true && scheduleResponse.Data != null)
      {
        AvailableSchedules = scheduleResponse.Data
        .Where(s => s.ScheduleDate.Date >= DateTime.Today)
        .Where(s => s.AvailableSlot > 0)
        .Where(s => s.Status == "Active")
        .OrderBy(s => s.ScheduleDate)
        .ToList();
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Gagal memuat semua jadwal: {ex.Message}");
    }
  }

  private async Task LoadOtherMenus(string categoryName, int currentMenuId)
  {
    try
    {
      var courseResponse = await Http.GetFromJsonAsync<ApiResponse<List<MenuCourseDto>>>("api/menucourses");
      if (courseResponse?.Success == true && courseResponse.Data != null)
      {
        OtherMenuItems = courseResponse.Data
        .Where(dto => dto.CategoryName.Equals(categoryName, StringComparison.OrdinalIgnoreCase) && dto.Id != currentMenuId)
        .Take(6)
        .Select(dto => new OtherMenu(
        dto.Id,
        dto.CategoryName,
        dto.Name,
        "IDR " + dto.Price.ToString("N0", idCulture),
        string.IsNullOrEmpty(dto.Image) ? "" : $"{_apiBaseUrl}/{dto.Image.TrimStart('/')}"
        ))
        .ToList();
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Gagal memuat menu lainnya: {ex.Message}");
    }
  }

  private void OnOtherMenuClick(int menuId)
  {
    NavManager.NavigateTo($"/menu/detail/{menuId}", forceLoad: true);
  }

  // =============================================
  // == FUNGSI BARU UNTUK E-COMMERCE (DIPERBAIKI) ==
  // =============================================

  /**
  * @brief Method void ini khusus untuk event @onclick tombol "Add to Cart".
*/
  private void AddToCart()
  {
    // Panggil method logika internal dan abaikan hasilnya
    AddToCartInternal();
  }

  /**
  * @brief Method ini berisi logika inti dan mengembalikan status sukses/gagal.
  * @return true jika berhasil ditambahkan, false jika gagal.
*/
  private bool AddToCartInternal()
  {
    if (course == null) return false;

    // 1. Validasi apakah jadwal sudah dipilih
    if (selectedScheduleId == 0)
    {
      Snackbar.Add("Please select a schedule first.", Severity.Warning);
      return false;
    }

    // 2. Dapatkan detail jadwal yang dipilih
    var selectedSchedule = AvailableSchedules.FirstOrDefault(s => s.Id == selectedScheduleId);
    if (selectedSchedule == null)
    {
      Snackbar.Add("The selected schedule is invalid.", Severity.Error);
      return false;
    }

    // 3. Buat objek CartItem (pastikan DTO/model ini ada di proyek Anda)
    var newItem = new CartItem
    {
      MSId = selectedSchedule.Id,
      MenuCourseId = course.Id,
      ScheduleId = selectedSchedule.ScheduleId,
      Name = course.Name,
      Category = course.CategoryName,
      Price = course.Price,
      ImageUrl = courseImageUrl,
      Schedule = selectedSchedule.ScheduleDate,
      Selected = true // Langsung tandai sebagai terpilih di keranjang
    };

    // 4. Panggil CartService untuk menambahkan item
    try
    {
      CartService.AddItem(newItem);
      Snackbar.Add($"{course.Name} added to cart.", Severity.Success);
      return true;
    }
    catch (Exception ex)
    {
      // Tangani jika ada error (misal: item sudah ada, dari logika service Anda)
      Snackbar.Add($"Failed to add: {ex.Message}", Severity.Error);
      return false;
    }
  }

  /**
  * @brief Menambahkan item ke keranjang lalu langsung mengarahkan ke halaman checkout.
*/
  private async void BuyNow()
  {
    await ShowPaymentDialog();
  }

  private async Task ShowPaymentDialog()
  {
    var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
    var dialog = DialogService.Show<PaymentMethod>("Select Payment Method", options);
    var result = await dialog.Result;

    // 3. Cek hasil dialog
    if (!result.Canceled && result.Data != null)
    {
      // Pengguna memilih metode, lanjutkan ke proses pembayaran
      int selectedPaymentId = (int)result.Data;
      await ProcessPayment();
    }
    else
    {
      // Pengguna menekan "Cancel"
      Snackbar.Add("Payment canceled.", Severity.Info);
    }
  }

  /**
  * @brief Langkah 2: Proses pembayaran setelah metode dipilih.
*/
  private async Task ProcessPayment()
  {
    isProcessingPayment = true;
    await InvokeAsync(StateHasChanged);

    List<int> selectedMSId = new List<int>();
    selectedMSId.Add(selectedScheduleId);

    // 1. Buat Data Request untuk API
    var createInvoiceRequest = new CreateInvoiceDTO()
    {
      MSId = selectedMSId
    };

    // 2. Panggil API Backend
    try
    {
      if (!string.IsNullOrWhiteSpace(token))
      {
        Console.WriteLine("üîë Token ditemukan, ambil data invoice...");

        var response = await InvoiceService.CreateinvoiceAsync(createInvoiceRequest, token);

        // if create invoice success
        if (response.Success)
        {
          Console.WriteLine($"üì¶ Invoice berhasil dibuat. {response}");

          NavManager.NavigateTo($"/purchase-success");
        }

        // if create invoice failed
        else if (!response.Success && response.Data is JsonElement details)
        {
          // Try to navigate into "courses" array
          if (details.TryGetProperty("courses", out var coursesElement) && coursesElement.ValueKind == JsonValueKind.Array)
          {
            var courseNames = coursesElement
            .EnumerateArray()
            .Select(c => c.GetProperty("courseName").GetString())
            .Where(name => !string.IsNullOrWhiteSpace(name));

            var joinedNames = string.Join(", ", courseNames);

            Snackbar.Add($"This course has already been puchased: {joinedNames}", Severity.Error);
          }
        }
        else
        {
          Snackbar.Add(response.Message, Severity.Error);
        }
      }
      else
      {
        Console.WriteLine("üö´ Token tidak tersedia: skip membuat invoice.");
        Snackbar.Add("You must to login first to purchase a course", Severity.Warning);
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Create invoice gagal: {ex.Message}");
    }
    finally
    {
      isProcessingPayment = false;
    }
  }
}