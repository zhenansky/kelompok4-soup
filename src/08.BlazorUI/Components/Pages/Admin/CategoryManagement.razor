@page "/admin-category"
@using MyApp.BlazorUI.Models
@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Components.Shared.Admin
@layout AdminLayout

@inject IDialogService DialogService
@inject CategoryService CategoryService
@inject ISnackbar Snackbar

<PageTitle>Category Management</PageTitle>

<MudPaper Elevation="2" Class="category-container">
    <!-- Header -->
    <div class="header-section">
        <MudText Typo="Typo.h5" Class="title">Category Management</MudText>

        <MudButton OnClick="OpenDialogAddCategoryAsync" Variant="Variant.Filled" Color="Color.Success"
            StartIcon="@Icons.Material.Filled.Add">
            Add Category
        </MudButton>
    </div>

    <!-- Table -->
    <div class="table-wrapper">
        <MudTable Items="@Categories" FixedHeader="true" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading"
            RowsPerPage="5" LoadingProgressColor="Color.Info" Class="category-table" Elevation="0">

            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Description</MudTh>
                <MudTh>Menus</MudTh>
                <MudTh>Image</MudTh>
                <MudTh>Action</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd>@context.Name</MudTd>
                <MudTd>@context.Description</MudTd>
                <MudTd>@context.MenuCourseCount</MudTd>
                <MudTd>
                    @if (!string.IsNullOrEmpty(context.Image))
                    {
                        <MudImage Src="@CategoryService.GetFullImageUrl(context.Image)" Width="40" Height="40"
                            Class="rounded-image" />
                    }
                </MudTd>
                <MudTd Class="action-buttons">
                    <MudTooltip Text="Edit Kategori">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" Size="Size.Medium"
                            OnClick="@(() => OpenDialogEditCategoryAsync(context))" />
                    </MudTooltip>

                    <MudTooltip Text="Hapus Kategori">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Medium"
                            OnClick="@(() => DeleteCategoryAsync(context))" />
                    </MudTooltip>
                </MudTd>
            </RowTemplate>

            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 5, 10, 25, 50, 100 }" />
            </PagerContent>
        </MudTable>
    </div>
</MudPaper>

@code {
    private bool _loading;
    private List<CategoryDto> Categories = new();

    protected override async Task OnInitializedAsync() => await LoadCategoriesAsync();

    private async Task LoadCategoriesAsync()
    {
        _loading = true;
        try
        {
            Categories = await CategoryService.GetAllAsync() ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"❌ Failed to load categories: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenDialogAddCategoryAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CategoryDialog>("Add Category", options: options);
        var result = await dialog.Result;

        if (result?.Canceled != false) return;
        if (result.Data is CreateCategoryDto createModel)
        {
            try
            {
                var added = await CategoryService.AddAsync(createModel);
                if (added != null)
                {
                    Categories.Add(added);
                    Snackbar.Add($"✅ Category '{added.Name}' added successfully.", Severity.Success);
                }
                else
                {
                    await LoadCategoriesAsync();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"❌ Failed to add category: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenDialogEditCategoryAsync(CategoryDto category)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var parameters = new DialogParameters { { "Title", "Edit Category" }, { "Category", category } };
        var dialog = await DialogService.ShowAsync<CategoryDialog>("Edit Category", parameters: parameters, options: options);
        var result = await dialog.Result;

        if (result?.Canceled != false) return;
        try
        {
            UpdateCategoryDto updateDto = result.Data switch
            {
                UpdateCategoryDto u => u,
                CreateCategoryDto cm => new UpdateCategoryDto
                {
                    Name = cm.Name,
                    Description = cm.Description,
                    ImageFile = cm.ImageFile
                },
                _ => null!
            };

            var updated = await CategoryService.UpdateAsync(category.Id, updateDto);
            if (updated != null)
            {
                var idx = Categories.FindIndex(c => c.Id == category.Id);
                if (idx >= 0) Categories[idx] = updated;
                Snackbar.Add($"✅ Category '{updated.Name}' updated successfully.", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"❌ Failed to update category: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteCategoryAsync(CategoryDto category)
    {
        bool confirmed = await DialogService.ShowMessageBox(
        "Confirm Delete",
        $"Apakah kamu yakin ingin menghapus kategori '{category.Name}'?",
        yesText: "Yes", cancelText: "Cancel") ?? false;

        if (!confirmed) return;
        try
        {
            var success = await CategoryService.DeleteAsync(category.Id);
            if (success)
            {
                Categories.Remove(category);
                Snackbar.Add($"✅ Category '{category.Name}' deleted successfully.", Severity.Success);
            }
            else
            {
                Snackbar.Add($"⚠️ Failed to delete '{category.Name}'.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"❌ Error deleting category: {ex.Message}", Severity.Error);
        }
    }
}

<style>
    .category-container {
        padding: 1.5rem;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        height: calc(100vh - 5rem);
        display: flex;
        flex-direction: column;
    }

    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 0.5rem;
    }

    .title {
        font-weight: 600;
        color: #333;
    }

    .table-wrapper {
        flex: 1;
        overflow-x: auto;
    }

    .category-table {
        width: 100%;
        min-width: 700px;
    }

    .mud-table-head th {
        background-color: #e8f5e9 !important;
        color: #2e7d32;
        text-transform: uppercase;
        font-weight: 600;
        text-align: center;
    }

    .mud-table-cell {
        text-align: center;
        vertical-align: middle !important;
    }

    .rounded-image {
        border-radius: 8px;
        object-fit: cover;
    }

    .action-buttons {
        display: table-cell !important;
        vertical-align: middle !important;
        text-align: center;
        padding: 0.5rem;
    }

    .mud-table-row {
        vertical-align: middle !important;
    }


    /* RESPONSIVE */
    @@media (max-width: 768px) {
        .header-section {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.8rem;
        }

        .category-table {
            min-width: 100%;
        }

        .action-buttons {
            justify-content: flex-start;
        }

        .mud-icon-button {
            transform: scale(0.9);
        }
    }
</style>