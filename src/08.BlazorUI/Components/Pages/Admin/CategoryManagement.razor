@page "/admin-category"
@using MyApp.BlazorUI.Models
@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Components.Shared.Admin
@layout AdminLayout

@inject IDialogService DialogService
@inject CategoryService CategoryService
@inject ISnackbar Snackbar

<PageTitle>Category Management</PageTitle>

<MudPaper Elevation="2" Class="category-container">
    <div class="header-section">
        <MudText Typo="Typo.h5" Class="title">Category Management</MudText>
        <MudButton OnClick="OpenDialogAddCategoryAsync" Variant="Variant.Filled" Class="btn-add">
            Add Category
        </MudButton>
    </div>

    <MudTable Items="@Categories" FixedHeader="true" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading"
        RowsPerPage="5" LoadingProgressColor="Color.Info" Class="category-table">
        <HeaderContent>
            <MudTh class="t">Name</MudTh>
            <MudTh class="t">Description</MudTh>
            <MudTh class="t">Menus</MudTh>
            <MudTh class="t">Image</MudTh>
            <MudTh class="t">Action</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd class="t">@context.Name</MudTd>
            <MudTd class="t">@context.Description</MudTd>
            <MudTd class="t">@context.MenuCourseCount</MudTd>
            <MudTd class="t">
                @if (!string.IsNullOrEmpty(context.Image))
                {
                    <MudImage Src="@CategoryService.GetFullImageUrl(context.Image)" Width="40" Height="40" />
                }
            </MudTd>
            <MudTd class="t">
                <MudButton OnClick="@(() => OpenDialogEditCategoryAsync(context))" Variant="Variant.Filled"
                    Class="btn-edit">
                    Edit
                </MudButton>
                <MudButton OnClick="@(() => DeleteCategoryAsync(context))" Variant="Variant.Filled" Class="btn-delete">
                    Delete
                </MudButton>
            </MudTd>
        </RowTemplate>


        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 5, 10, 25, 50, 100, int.MaxValue }" />
        </PagerContent>
    </MudTable>
</MudPaper>

@code {
    private bool _loading;
    private List<CategoryDto> Categories = new();

    protected override async Task OnInitializedAsync() => await LoadCategoriesAsync();

    private async Task LoadCategoriesAsync()
    {
        _loading = true;
        try
        {
            Categories = await CategoryService.GetAllAsync() ?? new List<CategoryDto>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"❌ Failed to load categories: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    // ✅ ADD CATEGORY
    private async Task OpenDialogAddCategoryAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CategoryDialog>("Add Category", options: options);
        var result = await dialog.Result;

        // jika user cancel atau menutup dialog
        if (result == null || result.Canceled) return;

        // dialog mengembalikan CreateCategoryDto (sesuai implementasi dialog)
        if (result.Data is CreateCategoryDto createModel)
        {
            try
            {
                var added = await CategoryService.AddAsync(createModel);
                if (added != null)
                {
                    // langsung tambahkan ke list agar tampil tanpa reload penuh
                    Categories.Add(added);
                    Snackbar.Add($"✅ Category '{added.Name}' added successfully.", Severity.Success);
                }
                else
                {
                    // jika API tidak mengembalikan object, reload untuk sinkronisasi
                    await LoadCategoriesAsync();
                    Snackbar.Add("⚠️ Add succeeded but no data returned — refreshed list.", Severity.Warning);
                }
            }
            catch (Exception ex)
            {
                // tampilkan pesan error dan refresh list untuk konsistensi
                Snackbar.Add($"❌ Failed to add category: {ex.Message}", Severity.Error);
                await LoadCategoriesAsync();
            }
        }
    }

    // ✅ EDIT CATEGORY
    private async Task OpenDialogEditCategoryAsync(CategoryDto category)
    {
        if (category == null) return;

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var parameters = new DialogParameters { { "Title", "Edit Category" }, { "Category", category } };
        var dialog = await DialogService.ShowAsync<CategoryDialog>("Edit Category", parameters: parameters, options: options);
        var result = await dialog.Result;

        if (result == null || result.Canceled) return;

        try
        {
            // dialog mungkin mengembalikan CreateCategoryDto (sesuai implementasimu)
            // kita terima CreateCategoryDto juga dan konversi ke UpdateCategoryDto
            UpdateCategoryDto updateDto = null!;

            if (result.Data is UpdateCategoryDto u)
            {
                updateDto = u;
            }
            else if (result.Data is CreateCategoryDto cm)
            {
                updateDto = new UpdateCategoryDto
                {
                    Name = cm.Name,
                    Description = cm.Description,
                    ImageFile = cm.ImageFile
                };
            }
            else
            {
                // tipe tidak dikenali -> reload supaya tetap konsisten
                await LoadCategoriesAsync();
                Snackbar.Add("⚠️ Unexpected dialog result type — refreshed list.", Severity.Warning);
                return;
            }

            var updated = await CategoryService.UpdateAsync(category.Id, updateDto);
            if (updated != null)
            {
                // replace item lokal supaya UI langsung update
                var idx = Categories.FindIndex(c => c.Id == category.Id);
                if (idx >= 0)
                    Categories[idx] = updated;
                else
                    Categories.Insert(0, updated);

                Snackbar.Add($"✅ Category '{updated.Name}' updated successfully.", Severity.Success);
            }
            else
            {
                // backend tidak mengembalikan object -> reload
                await LoadCategoriesAsync();
                Snackbar.Add("⚠️ Update succeeded but no data returned — refreshed list.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"❌ Failed to update category: {ex.Message}", Severity.Error);
            await LoadCategoriesAsync();
        }
    }

    // ✅ DELETE CATEGORY
    private async Task DeleteCategoryAsync(CategoryDto category)
    {
        if (category == null) return;

        bool confirmed = await DialogService.ShowMessageBox(
        "Confirm Delete",
        $"Apakah kamu yakin ingin menghapus kategori '{category.Name}'?",
        yesText: "Yes", cancelText: "Cancel") ?? false;

        if (!confirmed) return;

        try
        {
            var success = await CategoryService.DeleteAsync(category.Id);
            if (success)
            {
                // hapus langsung dari list
                Categories.RemoveAll(c => c.Id == category.Id);
                Snackbar.Add($"✅ Category '{category.Name}' deleted successfully.", Severity.Success);
            }
            else
            {
                Snackbar.Add($"⚠️ Failed to delete '{category.Name}'.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"❌ Error deleting category: {ex.Message}", Severity.Error);
        }
    }
}


<style>
    .category-container {
        padding: 1.5rem;
        margin: 0;
        width: 100%;
        height: calc(100vh - 5rem);
        /* penuh tinggi layar, dikurangi navbar */
        overflow-y: auto;
        background-color: #fff;
        box-sizing: border-box;
    }

    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .title {
        font-weight: 600;
        color: #333;
    }

    .category-table {
        max-height: 65vh;
        overflow-y: auto;
        border-radius: 10px;
    }

    .mud-table {
        border-collapse: separate;
        border-spacing: 0 6px;
    }

    .mud-table-row {
        background-color: #ffffff;
        border-radius: 8px;
    }

    .mud-table-head th {
        background-color: #eaffea !important;
        font-weight: 600;
        text-transform: uppercase;
        color: #333;
        text-align: center;
        vertical-align: middle;
        padding: 0.75rem;
    }

    .t {
        text-align: center;
        vertical-align: middle !important;
        padding: 0.75rem;
    }

    /* Tombol-tombol */
    .btn-add {
        background-color: green;
        color: white;
        text-transform: none;
        padding: 0.5rem 1rem;
        font-weight: 500;
        border-radius: 8px;
    }

    .btn-edit {
        background-color: #fabc1d;
        color: white;
        text-transform: none;
        margin-right: 0.4rem;
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
    }

    .btn-delete {
        background-color: red;
        color: white;
        text-transform: none;
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
    }

    .btn-add:hover {
        background-color: darkgreen;
    }

    .btn-edit:hover {
        background-color: #e6a500;
    }

    .btn-delete:hover {
        background-color: darkred;
    }

    /* Tambahan spacing antar tombol agar tidak nempel */
    .mud-button {
        margin: 0.1rem;
    }

    /* Agar tabel punya jarak dari pinggir card */
    .mud-table-container {
        padding: 0 0.5rem;
    }
</style>