@page "/admin-user"
@layout AdminLayout
@using MyApp.BlazorUI.Components.Shared.Admin
@using MyApp.BlazorUI.Components.Models
@using MyApp.BlazorUI.Services
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject UserService UserService

<PageTitle>User Management</PageTitle>

<MudPaper Elevation="1" Style="padding: 1rem; height: calc(100vh - 8rem); display:flex; flex-direction:column;">
  <MudText Typo="Typo.h4" Class="mb-4">User Management</MudText>

  <MudButton OnClick="OpenAddUserDialog" Variant="Variant.Filled" Class="rounded-lg btn-add mb-3" Style="width:150px;">
    Add User
  </MudButton>

  <div style="flex:1; overflow-y:auto;">
    <MudTable Items="@Users" FixedHeader="true" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading"
      LoadingProgressColor="Color.Info" Class="mt-2" Elevation="0" RowsPerPage="5">
      <HeaderContent>
        <MudTh Class="t">Email</MudTh>
        <MudTh Class="t">Name</MudTh>
        <MudTh Class="t">Role</MudTh>
        <MudTh Class="t">Status</MudTh>
        <MudTh Class="t">Action</MudTh>
      </HeaderContent>
      <RowTemplate>
        <MudTd Class="t">@context.Email</MudTd>
        <MudTd Class="t">@context.Name</MudTd>
        <MudTd Class="t">@context.Role</MudTd>
        <MudTd Class="t">
          @if (context.Status == UserStatus.Active)
          {
            <MudChip T="UserStatus" Color="Color.Success" Variant="Variant.Filled">Active</MudChip>
          }
          else
          {
            <MudChip T="UserStatus" Color="Color.Error" Variant="Variant.Filled">Inactive</MudChip>
          }
        </MudTd>
        <MudTd Class="t">
          <MudButton OnClick="@(() => OpenEditUserDialog(context))" Variant="Variant.Filled"
            Class="rounded-lg btn-edit me-2">Edit</MudButton>
          <MudButton OnClick="@(() => DeleteUserAsync(context))" Variant="Variant.Filled" Class="rounded-lg btn-delete">
            Delete</MudButton>
        </MudTd>
      </RowTemplate>
      <PagerContent>
        <MudTablePager PageSizeOptions="new int[] { 5, 10, 25, 50, 100, int.MaxValue }" />
      </PagerContent>
    </MudTable>
  </div>
</MudPaper>


@code {
  private bool _loading;
  private List<UserModel> Users = new();

  protected override async Task OnInitializedAsync()
  {
    await LoadUsersAsync();
  }

  private async Task LoadUsersAsync()
  {
    _loading = true;
    try
    {
      Users = await UserService.GetUsersAsync();
      if (Users == null || !Users.Any())
        Snackbar.Add("Tidak ada data user ditemukan.", Severity.Info);
    }
    catch (Exception ex)
    {
      Snackbar.Add($"Gagal memuat data user: {ex.Message}", Severity.Error);
    }
    finally
    {
      _loading = false;
    }
  }

  private async Task OpenAddUserDialog()
  {
    var options = new DialogOptions
    {
      CloseOnEscapeKey = true,
      MaxWidth = MaxWidth.Medium,
      FullWidth = true
    };

    // Gunakan Show, bukan ShowAsync
    var dialogReference = DialogService.Show<AddUserDialog>("Add User", options);

    // Tunggu sampai dialog ditutup
    var result = await dialogReference.Result;

    // Jika Submit berhasil, result.Data = true
    if (result?.Data is true)
    {
      Snackbar.Add("User berhasil ditambahkan!", Severity.Success);
      await LoadUsersAsync(); // refresh table
    }
  }


  private async Task OpenEditUserDialog(UserModel user)
  {
    var options = new DialogOptions
    {
      CloseOnEscapeKey = true,
      MaxWidth = MaxWidth.Medium,
      FullWidth = true
    };

    var parameters = new DialogParameters { { "User", user } };
    var dialogReference = DialogService.Show<EditUserDialog>("Edit User", parameters, options);
    var result = await dialogReference.Result; // tunggu dialog selesai

    if (result?.Data is UserModel updatedUser)
    {
      var existing = Users.FirstOrDefault(u => u.Id == updatedUser.Id);
      if (existing != null)
      {
        existing.Name = updatedUser.Name;
        existing.Email = updatedUser.Email;
        existing.Role = updatedUser.Role;
        existing.Status = updatedUser.Status;
      }

      Snackbar.Add("User berhasil diupdate!", Severity.Success);
      StateHasChanged();
    }
  }

  private async Task DeleteUserAsync(UserModel user)
  {
    bool confirmed = await DialogService.ShowMessageBox(
    "Confirm Delete",
    $"Apakah kamu yakin ingin menghapus user {user.Name}?",
    yesText: "Yes", noText: "Cancel") ?? false;

    if (!confirmed)
      return;

    var success = await UserService.DeleteUserAsync(user.Id);
    if (success)
    {
      Snackbar.Add("User berhasil dihapus!", Severity.Success);
      await LoadUsersAsync(); // refresh table
    }
    else
    {
      Snackbar.Add("Gagal menghapus user!", Severity.Error);
    }
  }
}

<style>
  .btn-add {
    background-color: green;
    text-transform: none;
    color: white;
  }

  .btn-add:hover {
    background-color: #0f7a0f;
  }

  .btn-edit {
    background-color: #fabc1d;
    text-transform: none;
    color: white;
  }

  .btn-edit:hover {
    background-color: #f1b60d;
  }

  .btn-delete {
    background-color: red;
    text-transform: none;
    color: white;
  }

  .btn-delete:hover {
    background-color: darkred;
  }

  .mud-table-head th {
    background-color: #dbffdd !important;
  }

  .t {
    text-align: center;
  }
</style>