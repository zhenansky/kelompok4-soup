@page "/admin-dashboard"
@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Models
@layout AdminLayout
@inject DashboardService DashboardService
@inject InvoiceService InvoiceService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using MyApp.BlazorUI.Components.Shared.Admin

<PageTitle>Dashboard</PageTitle>

<MudPaper Elevation="1" Class="pa-4" Style="max-height: calc(100vh - 5rem); overflow-y: auto;">
  <MudText Typo="Typo.h4" Class="mb-4">Welcome, Admin</MudText>

  <!-- GRID CARD SECTION -->
  <MudGrid Spacing="2">
    <MudItem xs="12" sm="4">
      <MudCard Class="card" Style="background-color: #ef4444; color: white;">
        <MudCardHeader Class="d-flex justify-center align-center gap-2 py-2">
          <MudIcon Icon="@Icons.Material.Filled.PeopleAlt" />
          <MudText Typo="Typo.body2">Total User Active</MudText>
        </MudCardHeader>
        <MudCardContent Class="py-1">
          <MudText Typo="Typo.h3" Class="text-center">@totalUsersActive</MudText>
        </MudCardContent>
      </MudCard>
    </MudItem>

    <MudItem xs="12" sm="4">
      <MudCard Class="card" Style="background-color: #3b82f6; color: white;">
        <MudCardHeader Class="d-flex justify-center align-center gap-2 py-2">
          <MudIcon Icon="@Icons.Material.Filled.Payments" />
          <MudText Typo="Typo.body2">Total Payment</MudText>
        </MudCardHeader>
        <MudCardContent Class="py-1">
          <MudText Typo="Typo.h3" Class="text-center">@totalInvoices</MudText>
        </MudCardContent>
      </MudCard>
    </MudItem>

    <MudItem xs="12" sm="4">
      <MudCard Class="card" Style="background-color: #9333ea; color: white;">
        <MudCardHeader Class="d-flex justify-center align-center gap-2 py-2">
          <MudIcon Icon="@Icons.Material.Filled.PeopleAlt" />
          <MudText Typo="Typo.body2">Total Member</MudText>
        </MudCardHeader>
        <MudCardContent Class="py-1">
          <MudText Typo="Typo.h3" Class="text-center">@totalMembers</MudText>
        </MudCardContent>
      </MudCard>
    </MudItem>
  </MudGrid>

  <MudDivider Class="my-6" />

  <!-- TABLE SECTION -->
  <div style="overflow-x: auto;">
    <MudTable Items="@invoices" FixedHeader="true" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading"
      LoadingProgressColor="Color.Info" Dense="true" Class="rounded-lg shadow-sm border" Elevation="1"
      Style="min-width: 600px;">
      <HeaderContent>
        <MudTh>Email</MudTh>
        <MudTh>No. Invoice</MudTh>
        <MudTh>Date</MudTh>
        <MudTh>Total Course</MudTh>
        <MudTh>Total Price</MudTh>
        <MudTh>Action</MudTh>
      </HeaderContent>
      <RowTemplate>
        <MudTd DataLabel="Email">@(!string.IsNullOrWhiteSpace(context.Email) ? context.Email : "(no email)")</MudTd>
        <MudTd DataLabel="No. Invoice">@context.NoInvoice</MudTd>
        <MudTd DataLabel="Date">@context.Date.ToString("dddd, dd MMMM yyyy")</MudTd>
        <MudTd DataLabel="Total Course">@context.TotalCourse</MudTd>
        <MudTd DataLabel="Total Price">
          @("IDR " + context.TotalPrice.ToString("N0", new System.Globalization.CultureInfo("id-ID")))
        </MudTd>
        <MudTd DataLabel="Action">
          <MudButton OnClick="() => OpenDialogAsync(context.InvoiceId)" Variant="Variant.Filled"
            Class="rounded-lg button button-filled" Style="color:white; width:100px">
            Detail
          </MudButton>
        </MudTd>
      </RowTemplate>
      <PagerContent>
        <MudTablePager />
      </PagerContent>
    </MudTable>
  </div>
</MudPaper>

@code {
  private bool _loading;
  private int totalUsersActive;
  private int totalMembers;
  private int totalInvoices;
  private List<InvoiceItem> invoices = new();

  private readonly string token =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZW1haWwiOiJhZG1pbkBlbWFpbC5jb20iLCJuYW1lIjoiQWRtaW4iLCJzdGF0dXMiOiJBY3RpdmUiLCJqdGkiOiI4NmM2ODBmMC1lY2E1LTQzMmMtYjJkNi1iYmY2N2Q5ZTMxOWMiLCJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dzLzIwMDgvMDYvaWRlbnRpdHkvY2xhaW1zL3JvbGUiOiJBZG1pbiIsImV4cCI6MTc2MDk0NjIzNCwiaXNzIjoiTXlBcHAiLCJhdWQiOiJNeUFwcFVzZXJzIn0.xkIk73GPvcobuxSxGtH1ua4zScbEQjLTjr821SHS-kY";

  protected override async Task OnInitializedAsync()
  {
    _loading = true;

    try
    {
      totalUsersActive = await DashboardService.GetTotalActiveUsersAsync();
      totalMembers = await DashboardService.GetTotalMembersAsync();

      // ðŸ”¹ Ambil semua invoice dari API (sudah termasuk Email)
      invoices = await InvoiceService.GetInvoicesAsync(token);

      // ðŸ”¹ Tidak perlu dummy lagi, tapi tetap fallback aman
      foreach (var inv in invoices)
      {
        inv.Email ??= "(no email)";
      }

      totalInvoices = invoices.Count;

      Snackbar.Add("Dashboard data loaded successfully", Severity.Success);
    }
    catch (Exception ex)
    {
      Snackbar.Add($"Error loading dashboard: {ex.Message}", Severity.Error);
    }
    finally
    {
      _loading = false;
    }

  }

  private async Task OpenDialogAsync(int invoiceId)
  {
    var parameters = new DialogParameters
    {
      ["InvoiceId"] = invoiceId,
      ["Token"] = token
    };

    var options = new DialogOptions
    {
      CloseOnEscapeKey = true,
      MaxWidth = MaxWidth.Medium,
      FullWidth = true
    };

    await DialogService.ShowAsync<DetailDialog>("Detail Invoice", parameters, options);
  }
}

<style>
  .card {
    color: white;
  }

  .card-text {
    font-weight: bold;
  }

  .line {
    border: 1px solid black;
  }

  .mud-table-head th {
    background-color: #dbffdd !important;
  }

  .thead {
    text-align: center;
  }
</style>