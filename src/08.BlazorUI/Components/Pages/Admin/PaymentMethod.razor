@page "/admin-payment"
@using MyApp.BlazorUI.Components.Models
@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Components.Shared.Admin
@layout AdminLayout

@inject IDialogService DialogService
@inject PaymentService PaymentService
@inject ISnackbar Snackbar

<PageTitle>Payment Method</PageTitle>

<MudPaper Elevation="2" Class="payment-container">
  <div class="header-section">
    <MudText Typo="Typo.h5" Class="title">Payment Method</MudText>
    <MudButton OnClick="OpenDialogAddPaymentAsync" Variant="Variant.Filled" Class="btn-add">
      Add Payment Method
    </MudButton>
  </div>

  <MudTable Items="@Payments" FixedHeader="true" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading"
    LoadingProgressColor="Color.Info" Class="payment-table">
    <HeaderContent>
      <MudTh Class="t">Id</MudTh>
      <MudTh Class="t">Name</MudTh>
      <MudTh Class="t">Logo</MudTh>
      <MudTh Class="t">Status</MudTh>
      <MudTh Class="t">Action</MudTh>
    </HeaderContent>

    <RowTemplate>
      <MudTd Class="t">@context.Id</MudTd>
      <MudTd Class="t">@context.Name</MudTd>
      <MudTd Class="t">
        <MudImage Src="@context.Logo" Width="40" Height="40" Class="rounded" />
      </MudTd>
      <MudTd Class="t">
        @if (context.Status == PaymentStatus.Active)
        {
          <MudChip T="string" Color="Color.Success" Variant="Variant.Filled">Active</MudChip>
        }
        else
        {
          <MudChip T="string" Color="Color.Error" Variant="Variant.Filled">Inactive</MudChip>
        }
      </MudTd>
      <MudTd Class="t">
        <MudButton OnClick="@(() => OpenDialogEditPaymentAsync(context))" Variant="Variant.Filled" Class="btn-edit">
          Edit
        </MudButton>
        <MudButton OnClick="@(() => DeletePaymentAsync(context))" Variant="Variant.Filled" Class="btn-delete">
          Delete
        </MudButton>
      </MudTd>
    </RowTemplate>

    <PagerContent>
      <MudTablePager />
    </PagerContent>
  </MudTable>
</MudPaper>

@code {
  private bool _loading;
  private List<PaymentModel> Payments = new();

  protected override async Task OnInitializedAsync()
  {
    await LoadPaymentsAsync();
  }

  private async Task LoadPaymentsAsync()
  {
    _loading = true;
    try
    {
      Payments = await PaymentService.GetPaymentsAsync();
    }
    catch (Exception ex)
    {
      Snackbar.Add($"❌ Failed to load payments: {ex.Message}", Severity.Error);
    }
    finally
    {
      _loading = false;
      StateHasChanged();
    }
  }

  private async Task OpenDialogAddPaymentAsync()
  {
    var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
    var dialog = await DialogService.ShowAsync<AddPaymentDialog>("Add Payment", options: options);
    var result = await dialog.Result;

    if (result?.Data is true)
    {
      Snackbar.Add("✅ Payment method added successfully.", Severity.Success);
      await LoadPaymentsAsync();
    }
    else
    {
      Snackbar.Add("ℹ️ Payment creation canceled.", Severity.Info);
    }
  }

  private async Task OpenDialogEditPaymentAsync(PaymentModel payment)
  {
    var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
    var parameters = new DialogParameters { { "Payment", payment } };
    var dialog = await DialogService.ShowAsync<EditPaymentDialog>("Edit Payment", parameters: parameters, options: options);
    var result = await dialog.Result;

    if (result?.Data is true)
    {
      Snackbar.Add($"✅ Payment '{payment.Name}' updated successfully.", Severity.Success);
      await LoadPaymentsAsync();
    }
    else
    {
      Snackbar.Add("ℹ️ Edit canceled.", Severity.Info);
    }
  }

  private async Task DeletePaymentAsync(PaymentModel payment)
  {
    bool confirmed = await DialogService.ShowMessageBox(
    "Confirm Delete",
    $"Apakah kamu yakin ingin menghapus {payment.Name}?",
    yesText: "Yes", noText: "Cancel") ?? false;

    if (!confirmed)
    {
      Snackbar.Add("ℹ️ Delete canceled.", Severity.Info);
      return;
    }

    try
    {
      var success = await PaymentService.DeletePaymentAsync(payment.Id);
      if (success)
      {
        Snackbar.Add($"✅ Payment '{payment.Name}' deleted successfully.", Severity.Success);
        await LoadPaymentsAsync();
      }
      else
      {
        Snackbar.Add($"⚠️ Failed to delete '{payment.Name}'.", Severity.Warning);
      }
    }
    catch (Exception ex)
    {
      Snackbar.Add($"❌ Error deleting payment: {ex.Message}", Severity.Error);
    }
  }
}

<style>
  .payment-container {
    padding: 1.5rem;
    margin: 0 auto;
    max-width: 1000px;
    overflow: hidden;
    background-color: #fff;
  }

  .header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .payment-table {
    max-height: 60vh;
    overflow-y: auto;
  }

  .btn-add {
    background-color: green;
    color: white;
    text-transform: none;
  }

  .btn-edit {
    background-color: #fabc1d;
    color: white;
    text-transform: none;
    margin-right: 0.3rem;
  }

  .btn-delete {
    background-color: red;
    color: white;
    text-transform: none;
  }

  .btn-add:hover {
    background-color: darkgreen;
  }

  .btn-edit:hover {
    background-color: #e6a500;
  }

  .btn-delete:hover {
    background-color: darkred;
  }

  .mud-table-head th {
    background-color: #dbffdd !important;
  }

  .t {
    text-align: center;
    vertical-align: middle !important;
  }
</style>