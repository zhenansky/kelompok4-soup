@using MudBlazor
@using System.Net.Http.Json
@using MyApp.BlazorUI.DTOs
@inject IConfiguration Configuration
@inject HttpClient Http
@inject ILogger<PaymentMethod> Logger

<MudDialog>
  <TitleContent>
    <MudText Typo="Typo.h6" Align="Align.Center">Select Payment Method</MudText>
  </TitleContent>
  <DialogContent>
    @if (_isLoading)
    {
      <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
      <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
    }
    else
    {
      <MudStack Spacing="2">
        @foreach (var method in PaymentMethods)
        {
          <MudItem>
            <div class="payment-option @(SelectedPaymentId == method.PaymentMethodId ? "selected-method" : "")"
              @onclick="@(() => SetSelectedMethod(method.PaymentMethodId))">
              <div class="icon-circle">
                <img src="@GetFullLogoUrl(method.Logo)" class="payment-icon" />
              </div>
              <MudText Class="payment-name">@method.Name</MudText>
            </div>
          </MudItem>
        }
      </MudStack>
    }
  </DialogContent>
  <DialogActions>
    <div class="mud-dialog-actions d-flex justify-center mud-dialog-actions">
      <MudButton Variant="Variant.Outlined" Color="Color.Default" @onclick="Cancel" Class="action-btn cancel-btn">
        Cancel
      </MudButton>
      <MudButton Variant="Variant.Filled" Color="Color.Warning" @onclick="ConfirmPayNow"
        Disabled="@(SelectedPaymentId == null || _isLoading)" Class="action-btn pay-btn ml-3" Style="color:black;">
        Pay Now
      </MudButton>
    </div>
  </DialogActions>
</MudDialog>

@code {
  [CascadingParameter]
  public dynamic? MudDialog { get; set; }

  // State untuk komponen
  private List<PaymentMethodDto> PaymentMethods = new();
  private int? SelectedPaymentId { get; set; }
  private bool _isLoading = true;
  private string? _errorMessage;
  private string? ApiBaseUrl;

  /**
  * @brief Ambil data dari Backend saat dialog diinisialisasi.
*/
  protected override async Task OnInitializedAsync()
  {
    ApiBaseUrl = Configuration["ApiBaseUrl"];

    try
    {
      // Panggil API Backend Anda untuk mendapatkan daftar metode pembayaran
      var response = await Http.GetFromJsonAsync<ApiResponse<List<PaymentMethodDto>>>("api/payment-methods");
      if (response != null && response.Success)
      {
        PaymentMethods = response.Data; // Mengambil list dari properti .Data
      }
      else
      {
        _errorMessage = response?.Message ?? "Gagal memuat metode pembayaran.";
      }
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error fetching payment methods");
      _errorMessage = "Terjadi kesalahan saat menghubungi server.";
    }
    finally
    {
      _isLoading = false;
      await InvokeAsync(StateHasChanged);
    }
  }

  private string GetFullLogoUrl(string? logoFileName)
  {
    if (string.IsNullOrEmpty(logoFileName) || string.IsNullOrEmpty(ApiBaseUrl))
    {
      return string.Empty; // Atau gambar placeholder
    }

    // Menggabungkan: "http://localhost:5099/" + "payment-logos/" + "gopay.svg"
    return $"{ApiBaseUrl.TrimEnd('/')}/payment-logos/{logoFileName}";
  }

  /**
  * @brief Simpan ID yang dipilih dan update UI.
*/
  private async Task SetSelectedMethod(int methodId)
  {
    SelectedPaymentId = methodId;
    Logger.LogInformation($"Payment method selected: {methodId}");
    await InvokeAsync(StateHasChanged); // Pastikan UI update real-time
  }

  private async Task Cancel()
  {
    Logger.LogInformation("Cancel button clicked. Closing dialog without selection.");
    try
    {
      if (MudDialog != null)
      {
        MudDialog.Cancel();
      }
      else
      {
        Logger.LogWarning("MudDialog is null, cannot cancel.");
      }
    }
    catch (Exception ex)
    {
      Logger.LogError(ex, "Error during Cancel operation");
    }
  }

  /**
  * @brief Kembalikan ID (int) yang dipilih ke CheckOut.razor
*/
  private async Task ConfirmPayNow()
  {
    if (SelectedPaymentId != null)
    {
      Logger.LogInformation($"Pay Now button clicked. Selected payment method ID: {SelectedPaymentId.Value}. Closing dialog with result.");
      try
      {
        if (MudDialog != null)
        {
          MudDialog.Close(DialogResult.Ok(SelectedPaymentId.Value));
        }
        else
        {
          Logger.LogWarning("MudDialog is null, cannot close with result.");
        }
      }
      catch (Exception ex)
      {
        Logger.LogError(ex, "Error during ConfirmPayNow operation");
      }
    }
    else
    {
      Logger.LogWarning("Pay Now clicked but no payment method selected.");
    }
  }
}

<style>
  .payment-option {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 10px 8px;
    border-radius: 8px;
    transition: background-color 0.12s ease;
  }

  .payment-option:hover {
    background-color: #f5f5f5;
  }

  .payment-option.selected-method {
    background-color: #fff6df;
    border: 1px solid #f2b705;
  }

  .icon-circle {
    width: 44px;
    height: 44px;
    min-width: 44px;
    border-radius: 50%;
    background: #f6f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    box-shadow: 0 1px 2px rgba(16, 24, 40, 0.04);
  }

  .payment-icon {
    width: 20px;
    height: 20px;
    display: block;
    margin: 0 auto;
    max-height: 20px;
  }

  .payment-name {
    font-size: 16px;
    color: rgba(0, 0, 0, 0.85);
  }

  .action-btn {
    min-width: 100px;
    border-radius: 8px;
    font-weight: 500;
  }

  .cancel-btn {
    border: 1px solid #4b2e2e;
    color: #4b2e2e;
    background: #fff;
  }

  .pay-btn {
    background-color: #f2b705;
    color: #000;
    font-weight: 600;
  }

  .mud-dialog-actions {
    justify-content: center !important;
    margin-top: 16px;
    margin-bottom: 16px;
    gap: 12px;
  }

  .mud-dialog-title {
    text-align: center;
    width: 100%;
    font-weight: 600;
  }

  .mud-dialog {
    max-width: 400px !important;
    width: 90% !important;
  }
</style>