@page "/checkout"

@* == USING STATEMENTS == *@
@using MudBlazor
@using Blazored.LocalStorage
@using Microsoft.AspNetCore.Components
@using System.ComponentModel.DataAnnotations
@using MyApp.BlazorUI.Services
@using System.Net.Http.Json
@using System.Text.Json;
@using MyApp.BlazorUI.DTOs
@using MyApp.BlazorUI.Components.Shared
@using MyApp.BlazorUI.Services.Interfaces
@using MyApp.BlazorUI.DTOs.Auth

@* == INJECTS == *@
@inject IAuthService AuthService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject MyApp.BlazorUI.Services.CartService CartService
@inject HttpClient Http
@inject NavigationManager NavManager
@inject ILocalStorageService LocalStorage
@inject InvoiceService InvoiceService


@implements IDisposable

<PageTitle>Checkout</PageTitle>

<MudPaper Elevation="0" Class="pt-2" Style="min-height: 100%;">
  <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors" Class="py-4 px-10">

    <MudPaper Elevation="0" Class="d-flex align-center">
      <MudCheckBox T="bool" @bind-Value="SelectAll" @bind-Value:after="OnSelectAllChanged" Label=" Pilih Semua" />
    </MudPaper>

    <MudDivider Style="border-top: 2px solid rgba(0,0,0,0.77);" />

    <MudPaper Elevation="0" Class="pa-4" style="height: calc(100vh - 15rem); overflow: auto;">
      @if (!CartItems.Any())
      {
        <MudText Align="Align.Center" Class="mt-10">Keranjang Anda kosong.</MudText>
      }
      else
      {
        @foreach (var item in CartItems)
        {
          <MudGrid Class="align-center" @key="@(item.MenuCourseId + "-" + item.ScheduleId)">
            <MudItem xs="2" sm="1" md="1">
              <MudCheckBox T="bool" @bind-Value="item.Selected" @bind-Value:after="OnItemSelectionChanged" />
            </MudItem>
            <MudItem xs="12" sm="4" md="2">
              <MudImage Src="@item.ImageUrl" Alt="@item.Name" Fluid="true" Style="width: 12.5rem; height: 8.3rem;" />
            </MudItem>
            <MudItem xs="10" sm="6" md="8">
              <div class="d-flex flex-column">
                <MudText Typo="Typo.caption" style="color: #828282;">@item.Category</MudText>
                <MudText Typo="Typo.h6" style="font-weight: 600;">@item.Name</MudText>
                <MudText Typo="Typo.body2" Color="Color.Default">
                  Schedule: @item.Schedule.ToString("dddd, dd MMMM yyyy")
                </MudText>
                <MudText Typo="Typo.subtitle1" style="color: #FABC1D; font-weight: 500;">
                  IDR @item.Price.ToString("N0")
                </MudText>
              </div>
            </MudItem>
            <MudItem xs="2" sm="1" md="1" Class="d-flex justify-end align-center">
              <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => RemoveItem(item))" />
            </MudItem>
          </MudGrid>
          <MudDivider Class="my-2" Style="border-top: 2px solid rgba(0,0,0,0.77);" />
        }
      }
    </MudPaper>
  </MudForm>

  <MudDivider Class="my-2" Style="border-top: 2px solid rgba(0,0,0,0.77); width: 100%;" />

  <MudPaper Height="4rem" Elevation="0" Class="d-flex justify-between align-center px-10">
    <MudText Typo="Typo.subtitle1" Class="mr-4">Total Price</MudText>
    <MudText Typo="Typo.h6" style="color: #FABC1D;">IDR @_totalPrice.ToString("N0")</MudText>
    <MudSpacer />
    <MudButton Variant="Variant.Filled" Class="button button-filled rounded-lg" Style="width: 14.5rem;"
      DropShadow="false" OnClick="@ShowPaymentDialog" Disabled="@(isProcessingPayment || _totalPrice <= 0)">
      @if (isProcessingPayment)
      {
        <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-2" />
        <text>Processing...</text>
      }
      else
      {
        <text>Pay Now</text>
      }
    </MudButton>
  </MudPaper>
</MudPaper>


@code {
  MudForm? form;
  bool success;
  string[] errors = { };
  private bool isProcessingPayment = false;
  string? token = null;
  private bool _disposed;

  private bool SelectAll;
  private decimal _totalPrice => CartItems.Where(i => i.Selected).Sum(i => i.Price);
  private List<CartItem> CartItems = new List<CartItem>();

  protected override void OnInitialized()
  {
    LoadCartItems();
    CartService.OnChange += HandleCartChange;
  }

  private void LoadCartItems()
  {
    CartItems = CartService.GetItems();
    CalculateSelectAll();
  }

  private void HandleCartChange()
  {
    LoadCartItems();
    InvokeAsync(StateHasChanged);
  }

  private void OnSelectAllChanged()
  {
    foreach (var item in CartItems)
    {
      item.Selected = SelectAll;
    }
  }

  private void OnItemSelectionChanged()
  {
    CalculateSelectAll();
  }

  private void CalculateSelectAll()
  {
    SelectAll = CartItems.Any() && CartItems.All(i => i.Selected);
  }

  private void RemoveItem(CartItem item)
  {
    CartService.RemoveItem(item);
  }

  // =============================================
  // == LOGIKA PEMBAYARAN E-COMMERCE BARU ==
  // =============================================

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender)
      return;

    if (_disposed) return;

    try
    {
      var authState = await AuthService.IsUserAuthenticatedAsync();
      if (_disposed) return;
      if (!authState)
      {
        NavManager.NavigateTo("/", forceLoad: true);
      }

      token = await LocalStorage.GetItemAsync<string>(key: "accessToken");
    }
    catch (Exception ex)
    {
      if (!_disposed)
        Console.WriteLine("‚ö†Ô∏è LocalStorage belum siap atau tidak tersedia: " + ex.Message);
    }
  }

  /**
  * @brief Langkah 1: Buka dialog pemilihan metode pembayaran.
*/
  private async Task ShowPaymentDialog()
  {
    // 1. Validasi Item Keranjang
    if (_totalPrice <= 0)
    {
      Snackbar.Add("No item selected.", Severity.Info);
      return;
    }

    // 2. Buka Dialog
    var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
    var dialog = DialogService.Show<PaymentMethod>("Select Payment Method", options);
    var result = await dialog.Result;

    // 3. Cek hasil dialog
    if (!result.Canceled && result.Data != null)
    {
      // Pengguna memilih metode, lanjutkan ke proses pembayaran
      int selectedPaymentId = (int)result.Data;
      await ProcessPayment();
    }
    else
    {
      // Pengguna menekan "Cancel"
      Snackbar.Add("Payment canceled.", Severity.Info);
    }
  }

  /**
  * @brief Langkah 2: Proses pembayaran setelah metode dipilih.
*/
  private async Task ProcessPayment()
  {
    isProcessingPayment = true;
    await InvokeAsync(StateHasChanged);

    var selectedItems = CartItems.Where(item => item.Selected).ToList();
    var selectedMSId = selectedItems.Select(item => item.MSId).ToList();

    // 1. Buat Data Request untuk API
    var createInvoiceRequest = new CreateInvoiceDTO()
    {
      MSId = selectedMSId
    };

    // 2. Panggil API Backend
    try
    {
      if (!string.IsNullOrWhiteSpace(token))
      {
        Console.WriteLine("üîë Token ditemukan, ambil data invoice...");

        var response = await InvoiceService.CreateinvoiceAsync(createInvoiceRequest, token);

        // if create invoice success
        if (response.Success)
        {
          Console.WriteLine($"üì¶ Invoice berhasil dibuat. {response}");

          foreach (var item in selectedItems)
          {
            CartService.RemoveItem(item);
          }

          NavManager.NavigateTo($"/purchase-success");
        }

        // if create invoice failed
        else if (!response.Success && response.Data is JsonElement details)
        {
          // Try to navigate into "courses" array
          if (details.TryGetProperty("courses", out var coursesElement) && coursesElement.ValueKind == JsonValueKind.Array)
          {
            var courseNames = coursesElement
            .EnumerateArray()
            .Select(c => c.GetProperty("courseName").GetString())
            .Where(name => !string.IsNullOrWhiteSpace(name));

            var joinedNames = string.Join(", ", courseNames);

            Snackbar.Add($"This course has already been puchased: {joinedNames}", Severity.Error);
          }
        }
        else
        {
          Snackbar.Add(response.Message, Severity.Error);
        }
      }
      else
      {
        Console.WriteLine("üö´ Token tidak tersedia: skip membuat invoice.");
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Create invoice gagal: {ex.Message}");
    }
    finally
    {
      isProcessingPayment = false;
      StateHasChanged();
    }
  }

  public void Dispose()
  {
    _disposed = true;
    CartService.OnChange -= HandleCartChange;
  }
}

<style>
  body {
    height: 100vh;
  }

  .mud-main-content {
    height: 100%;
  }

  .sticky-footer {
    position: sticky;
    bottom: 0;
    z-index: 100;
  }
</style>