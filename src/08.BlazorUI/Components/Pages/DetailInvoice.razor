@page "/invoice/detail/{id:int}"
@using Blazored.LocalStorage
@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Models
@using MyApp.BlazorUI.Services.Interfaces
@inject NavigationManager Navigation
@inject InvoiceService InvoiceService
@inject ILocalStorageService LocalStorage
@inject IAuthService AuthService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="page-container">
  <MudItem Class="px-12 mt-10">
    <MudBreadcrumbs Items="_items" Separator=">" />
  </MudItem>

  @if (_loading)
  {
    <div class="d-flex align-items-center justify-content-center" style="height: 100%;">
      <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
      <MudText Typo="Typo.h6" Class="ml-3">Loading...</MudText>
    </div>
  }
  else
  {
    <MudItem class="px-14 my-10 d-flex flex-column content-area">
      <MudText Typo="Typo.h6" Style="font-weight: 600;">Detail Invoice</MudText>

      <MudGrid Class="mt-4">
        <MudItem xs="12" sm="6" Class="d-flex gap-8">
          <MudItem>
            <MudText>No. Invoice:</MudText>
            <MudText>Date:</MudText>
          </MudItem>
          <MudItem>
            <MudText>@(InvoiceDetail?.NoInvoice ?? "-")</MudText>
            <MudText>
              @(InvoiceDetail?.Date != DateTime.MinValue
                          ? InvoiceDetail?.Date.ToString("dddd, dd MMMM yyyy", new System.Globalization.CultureInfo("en-EN"))
                          : "-")
            </MudText>
          </MudItem>
        </MudItem>

        <MudItem xs="12" sm="6" Class="d-flex justify-end align-end gap-8">
          <MudText Typo="Typo.body1" Style="font-weight:700;">Total Price</MudText>
          <MudText Typo="Typo.body1" Style="font-weight:700;">
            @("IDR " + (InvoiceDetail?.TotalPrice ?? 0).ToString("N0", new System.Globalization.CultureInfo("id-ID")))
          </MudText>
        </MudItem>
      </MudGrid>

      <MudTable T="InvoiceCourseData" Items="@Details" Hover="true" Striped="true" Class="mx-0 mt-6">
        <HeaderContent>
          <MudTh Class="custom-header left-cell" style="color:white; width:5%">No.</MudTh>
          <MudTh Class="custom-header center-cell" style="color:white; width:45%">Course Name</MudTh>
          <MudTh Class="custom-header center-cell" style="color:white; width:15%">Type</MudTh>
          <MudTh Class="custom-header center-cell" style="color:white; width:20%">Schedule</MudTh>
          <MudTh Class="custom-header center-cell" style="color:white; width:15%">Price</MudTh>
        </HeaderContent>
        <RowTemplate>
          <MudTd Class="left-cell" DataLabel="No.">@(Details.IndexOf(context) + 1)</MudTd>
          <MudTd Class="center-cell" DataLabel="Course Name">@context.Name</MudTd>
          <MudTd Class="center-cell" DataLabel="Type">@context.Category</MudTd>
          <MudTd Class="center-cell" DataLabel="Schedule">@context.ScheduleDate.ToString("dddd, dd MMMM yyyy", new
                      System.Globalization.CultureInfo("en-EN"))</MudTd>
        <MudTd Class="center-cell" DataLabel="Price">IDR @context.Price.ToString("N0")</MudTd>
      </RowTemplate>
      <NoRecordsContent>
        <MudText Class="m-3">No course data found.</MudText>
      </NoRecordsContent>
    </MudTable>
  </MudItem>
    }
</MudContainer>

@code {
  [Parameter]
  public int id { get; set; }

  private bool _loading;
  private bool _loaded;
  private InvoiceDetailData InvoiceDetail = new();
  private List<InvoiceCourseData> Details = new();

  protected override async Task OnInitializedAsync()
  {
    _loading = true;
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender || _loaded)
      return;

    _loading = true;

    try
    {
      var authState = await AuthService.IsUserAuthenticatedAsync();
      if (!authState)
      {
        Navigation.NavigateTo("/", forceLoad: true);
      }

      string? token = null;
      try
      {
        token = await LocalStorage.GetItemAsync<string>("accessToken");
      }
      catch (Exception ex)
      {
        Console.WriteLine("‚ö†Ô∏è LocalStorage belum siap atau tidak tersedia: " + ex.Message);
      }

      if (!string.IsNullOrWhiteSpace(token))
      {
        InvoiceDetail = await InvoiceService.GetInvoiceDetailAsync(id, token);
        Details = InvoiceDetail?.ListCourse ?? new List<InvoiceCourseData>();
      }
      else
      {
        Console.WriteLine("üö´ Token tidak tersedia: skip memuat invoice.");
      }

      _loaded = true;
      StateHasChanged();
    }
    catch (Exception ex)
    {
      Console.WriteLine($"‚ùå Invoices error: {ex}");
    }
    finally
    {
      _loading = false;
      StateHasChanged();
    }
  }

  private List<BreadcrumbItem> _items = new()
{
new("Home", href: "/"),
new("Invoice", href: "/invoice"),
new("Detail Invoice", href: null, disabled: true)
};

  private string RowClassFunc(InvoiceCourseData detail, int rowNumber)
  {
    return (rowNumber % 2 == 1) ? "even-row" : "odd-row";
  }
}

<style>
  .page-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    position: relative;
  }

  .content-area {
    flex: 1;
  }

  .footer {
    margin-top: auto;
    padding: 16px;
    text-align: center;
    background-color: #f8f9fa;
    border-top: 1px solid #ddd;
  }

  .custom-header {
    background-color: #5B4947;
  }

  .odd-row {
    background-color: #ffffff;
  }

  .even-row {
    background-color: #f5f5f5;
  }

  .center-cell {
    text-align: center;
  }

  .left-cell {
    text-align: left;
  }
</style>