@page "/invoice/detail/{id:int}"
@using Blazored.LocalStorage
@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Models
@using MyApp.BlazorUI.Services.Interfaces
@inject NavigationManager Navigation
@inject InvoiceService InvoiceService
@inject ILocalStorageService LocalStorage
@inject IAuthService AuthService

<style>
  .custom-header {
    background-color: #5B4947;
  }

  /* Row ganjil putih, genap abu-abu */
  .odd-row {
    background-color: #ffffff;
  }

  .even-row {
    background-color: #f5f5f5;
  }

  /* Align cell */
  .center-cell {
    text-align: center;
  }

  .left-cell {
    text-align: left;
  }
</style>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
  <MudItem Class="px-12 mt-10">
    <MudBreadcrumbs Items="_items" Separator=">">
    </MudBreadcrumbs>
  </MudItem>

  <MudItem class="px-14 my-10 d-flex flex-column">
    <MudText Typo="Typo.h6" Style="font-weight: 600;">Detail Invoice</MudText>

    <MudGrid Class="mt-4">
      <MudItem xs="12" sm="6" Class="d-flex gap-8">
        <MudItem>
          <MudText>No. Invoice:</MudText>
          <MudText>Date:</MudText>
        </MudItem>
        <MudItem>
          <MudText>@(InvoiceDetail?.NoInvoice ?? "-")</MudText>
          <MudText>
            @(InvoiceDetail?.Date != DateTime.MinValue
                        ? InvoiceDetail?.Date.ToString("dddd, dd MMMM yyyy", new System.Globalization.CultureInfo("en-EN"))
                        : "-")
          </MudText>
        </MudItem>
      </MudItem>

      <MudItem xs="12" sm="6" Class="d-flex justify-end align-end gap-8">
        <MudText Typo="Typo.body1" Style="font-weight:700;">Total Price</MudText>
        <MudText Typo="Typo.body1" Style="font-weight:700;">
          @("IDR " + (InvoiceDetail?.TotalPrice ?? 0).ToString("N0", new System.Globalization.CultureInfo("id-ID")))
        </MudText>
      </MudItem>
    </MudGrid>
  </MudItem>

  <MudTable T="InvoiceCourseData" Items="@Details" Hover="true" Bordered="false" Striped="true"
    RowClassFunc="RowClassFunc" Class="mx-14 mt-4">
    <HeaderContent>
      <MudTh Class="custom-header left-cell" style="color:white; width:5%">No.</MudTh>
      <MudTh Class="custom-header center-cell" style="color:white; width:45%">Course Name</MudTh>
      <MudTh Class="custom-header center-cell" style="color:white; width:15%">Type</MudTh>
      <MudTh Class="custom-header center-cell" style="color:white; width:20%">Schedule</MudTh>
      <MudTh Class="custom-header center-cell" style="color:white; width:15%">Price</MudTh>
    </HeaderContent>
    <RowTemplate>
      <MudTd Class="left-cell" DataLabel="No.">@(Details.IndexOf(context) + 1)</MudTd>
      <MudTd Class="center-cell" DataLabel="Course Name">@context.Name</MudTd>
      <MudTd Class="center-cell" DataLabel="Type">@context.Category</MudTd>
      <MudTd Class="center-cell" DataLabel="Schedule">@context.ScheduleDate.ToString("dddd, dd MMMM yyyy", new
                System.Globalization.CultureInfo("en-EN"))</MudTd>
      <MudTd Class="center-cell" DataLabel="Price">IDR @context.Price.ToString("N0")</MudTd>
    </RowTemplate>
  </MudTable>

</MudContainer>

@code {
  [Parameter]
  public int id { get; set; }
  private bool _loading;
  private bool _loaded;
  private int totalInvoices;
  private InvoiceDetailData InvoiceDetail = new();
  private List<InvoiceCourseData> Details = new();

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender || _loaded)
      return;

    _loading = true;

    try
    {
      // 2Ô∏è‚É£ Coba baca token dari LocalStorage
      string? token = null;
      try
      {
        token = await LocalStorage.GetItemAsync<string>("accessToken");
      }
      catch (Exception ex)
      {
        Console.WriteLine("‚ö†Ô∏è LocalStorage belum siap atau tidak tersedia: " + ex.Message);
      }

      // 3Ô∏è‚É£ Kalau token ada, ambil data invoice
      if (!string.IsNullOrWhiteSpace(token))
      {
        Console.WriteLine("üîë Token ditemukan, ambil data invoice...");

        InvoiceDetail = await InvoiceService.GetInvoiceDetailAsync(id, token);
        if (InvoiceDetail != null)
        {
          Details = InvoiceDetail.ListCourse;
        }
        else
        {
          Details.Clear();
        }
      }
      else
      {
        Console.WriteLine("üö´ Token tidak tersedia: skip memuat invoice.");
      }

      _loaded = true;
      StateHasChanged(); // ‚¨ÖÔ∏è Pastikan UI refresh setelah data terload
    }
    catch (Exception ex)
    {
      Console.WriteLine($"‚ùå Invoices error: {ex}");
    }
    finally
    {
      _loading = false;
      StateHasChanged();
    }
  }


  private List<BreadcrumbItem> _items = new()
{
new("Home", href: "/"),
new("Invoice", href: "/invoice"),
new("Detail Invoice", href: null, disabled: true)
};


  private string RowClassFunc(InvoiceCourseData detail, int rowNumber)
  {
    return (rowNumber % 2 == 1) ? "even-row" : "odd-row";
  }
}