@inherits LayoutComponentBase
@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Services.Interfaces
@using System.IdentityModel.Tokens.Jwt;
@using Blazored.LocalStorage;
@inject NavigationManager Navigation
@inject IAuthService AuthService
@inject Blazored.LocalStorage.ILocalStorageService _localStorage



<MudThemeProvider Theme="CustomTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>

  @* navbar pc screen *@
  <MudAppBar Elevation="0" Style="height:5.375rem; width: 100vw; background-color:#ffffff;"
    class="d-flex justify-center px-13">

    <MudPaper Elevation="0" Width="100%" Class="d-flex justify-space-between">
      <MudLink Href="/">
        <MudImage Src="/logo.svg" Width="55" Height="50" />
      </MudLink>

      <MudPaper Elevation="0">
        <NavMenu Css="d-none d-sm-flex align-center gap-10" />
      </MudPaper>

      <MudPaper Elevation="0" Class="d-flex d-sm-none">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" OnClick="@((e) => DrawerToggle())" />
      </MudPaper>
    </MudPaper>

  </MudAppBar>

  @* navbar phone screen *@
  <MudDrawer @bind-Open="@drawerOpen" Anchor="Anchor.Right" Class="d-flex d-sm-none">
    <MudDrawerHeader Class="d-flex align-center">
      <MudText Class="d-flex justify-center" Style="width: 100%;" Typo="Typo.h6">Menu</MudText>
      <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit" @onclick="DrawerToggle" />
    </MudDrawerHeader>

    <MudPaper Elevation="0">
      <MudDivider Class="my-1 line" />
      <NavMenu Css="d-flex flex-column" />
    </MudPaper>

  </MudDrawer>

  @* main content *@
  <MudMainContent>
    @Body
  </MudMainContent>

  @* footer *@
  @if (ShowFooter)
  {
    <MudPaper>
      <Footer />
    </MudPaper>
  }

</MudLayout>

@code {
  bool drawerOpen = false;

  private DateTime? GetJwtExpiry(string? token)
  {
    if (string.IsNullOrEmpty(token)) return null;

    var handler = new JwtSecurityTokenHandler();
    if (!handler.CanReadToken(token)) return null;

    var jwt = handler.ReadJwtToken(token);
    var exp = jwt.Payload.Expiration;
    return exp.HasValue
    ? DateTimeOffset.FromUnixTimeSeconds(exp.Value).UtcDateTime
    : null;
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender) return;

    try
    {
      // ✅ Check if user has an access token
      var token = await _localStorage.GetItemAsync<string>("accessToken");
      if (string.IsNullOrWhiteSpace(token))
      {
        Console.WriteLine("ℹ️ No access token found — user not logged in, skip refresh.");
        return;
      }

      // 🕓 Parse access token expiry (from JWT)
      var expiry = GetJwtExpiry(token);
      if (expiry == null)
      {
        Console.WriteLine("⚠️ Invalid access token format — skip refresh.");
        return;
      }

      // ✅ Only refresh if token expired or expiring in <10 seconds
      if (DateTime.UtcNow >= expiry.Value.AddSeconds(-10))
      {
        Console.WriteLine($"🔁 Access token expired/expiring soon ({expiry:O}) — refreshing...");
        var res = await AuthService.RefreshTokenAsync();
        Console.WriteLine(res?.Success == true
        ? "✅ Access token refreshed."
        : "⚠️ Token refresh failed or not needed.");
      }
      else
      {
        Console.WriteLine($"🟢 Access token still valid until {expiry:O}");
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"⚠️ Error checking/refreshing access token: {ex.Message}");
    }
  }

  void DrawerToggle()
  {
    drawerOpen = !drawerOpen;
  }

  MudTheme CustomTheme = new MudTheme()
  {
    Typography = new Typography()
    {
      Default = new DefaultTypography()
      {
        FontFamily = new[] { "Montserrat", "Helvetica", "Arial", "sans-serif" }
      }
    }
  };

  private bool ShowFooter => !IsAuthPage;

  private bool IsAuthPage =>
  Navigation.Uri.Contains("login", StringComparison.OrdinalIgnoreCase) ||
  Navigation.Uri.Contains("register", StringComparison.OrdinalIgnoreCase) ||
  Navigation.Uri.Contains("reset-password", StringComparison.OrdinalIgnoreCase) ||
  Navigation.Uri.Contains("new-password", StringComparison.OrdinalIgnoreCase) ||
  Navigation.Uri.Contains("email-success", StringComparison.OrdinalIgnoreCase) ||
  Navigation.Uri.Contains("checkout", StringComparison.OrdinalIgnoreCase);
}

<style>
  .line {
    border: 1px solid black;
  }
</style>